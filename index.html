<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inscription Professionnels - Plateforme</title>
<link rel="icon" href="data:," />
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f0f4f8;
  padding: 20px;
  margin: 0;
}
.container {
  max-width: 700px;
  margin: 0 auto;
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
h1 {
  color: #2c3e50;
  margin-bottom: 10px;
  font-size: 28px;
}
.subtitle {
  color: #7f8c8d;
  margin-bottom: 30px;
  font-size: 15px;
}
.question { margin-bottom: 25px; }
label { display: block; font-weight: 600; margin-bottom: 8px; color: #34495e; font-size: 15px; }
.required { color: #e74c3c; font-weight: bold; }
input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e6ed;
  border-radius: 6px;
  font-size: 15px;
  transition: border-color 0.3s;
  box-sizing: border-box;
}
input:focus, select:focus { outline: none; border-color: #3498db; }
.checkbox-group, .radio-group { margin-top: 8px; }
.checkbox-group label, .radio-group label { display: flex; align-items: center; font-weight: normal; margin-bottom: 8px; cursor: pointer; }
input[type="checkbox"], input[type="radio"] { margin-right: 8px; cursor: pointer; width: 18px; height: 18px; }
.hidden { display: none; }
.error { color: #e74c3c; font-size: 13px; margin-top: 5px; display: none; }
.show-error { display: block; }
.message-box {
  background: #fff3cd;
  border: 2px solid #ffc107;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  color: #856404;
}
.message-box h3 { margin-top: 0; color: #856404; }
.info-box {
  background: #d1ecf1;
  border: 2px solid #17a2b8;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  color: #0c5460;
}
.info-box h3 { margin-top: 0; color: #0c5460; }
.success-box {
  background: #d4edda;
  border: 2px solid #28a745;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  color: #155724;
}
.success-box h3 { margin-top: 0; color: #155724; }
button {
  width: 100%;
  padding: 14px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
  margin-top: 20px;
}
button:hover { background: #2980b9; }
button:disabled { background: #95a5a6; cursor: not-allowed; }
.consent-label { display: flex; align-items: flex-start; gap: 8px; }
.consent-label input { margin-top: 3px; flex-shrink: 0; }
.success-message {
  background: #d4edda;
  border: 2px solid #28a745;
  color: #155724;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  display: none;
}
.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-top: none;
  z-index: 99;
  max-height: 150px;
  overflow-y: auto;
  background: white;
  width: 100%;
}
.autocomplete-item {
  padding: 10px;
  cursor: pointer;
}
.autocomplete-item:hover {
  background-color: #e9e9e9;
}
.code-verification {
  background: #e7f3ff;
  border: 2px solid #2196F3;
  border-radius: 8px;
  padding: 25px;
  margin: 20px 0;
  text-align: center;
}
.code-verification h3 {
  color: #1976D2;
  margin-top: 0;
}
.code-input {
  width: 200px !important;
  text-align: center;
  font-size: 24px;
  letter-spacing: 10px;
  font-weight: bold;
  margin: 15px auto;
}
input[readonly] {
  background-color: #f3f6f9;
  color: #555;
}
.date-picker-box {
  background: #f8f9fa;
  border: 2px solid #6c757d;
  border-radius: 8px;
  padding: 20px;
  margin: 15px 0;
}
.date-picker-box label {
  color: #495057;
  font-size: 14px;
}
input[type="date"] {
  font-size: 16px;
  padding: 10px;
}
</style>
</head>
<body>

<div class="container">
  <h1>Inscription Professionnels - Plateforme</h1>
  <p class="subtitle">Formulaire d'inscription pour les professionnels souhaitant √™tre r√©f√©renc√©s sur cette plateforme.</p>

  <div id="messageStop" class="message-box hidden">
    <h3>‚ö†Ô∏è Acc√®s non autoris√©</h3>
    <p>Ce formulaire est r√©serv√© aux professionnels disposant d'un num√©ro ADELI ou SIRET.</p>
  </div>

  <div id="messageEmailExiste" class="info-box hidden">
    <h3>üìß Email d√©j√† enregistr√©</h3>
    <p>Cet email est d√©j√† associ√© √† une inscription. Pour modifier vos informations, un code de v√©rification a √©t√© envoy√© √† votre adresse email.</p>
    <p><strong>Veuillez v√©rifier votre bo√Æte mail et entrer le code re√ßu ci-dessous.</strong></p>
  </div>

  <div id="messageEmailNouveau" class="success-box hidden">
    <h3>‚úÖ Nouvel email d√©tect√©</h3>
    <p>Pour des raisons de s√©curit√©, un code de v√©rification a √©t√© envoy√© √† votre adresse email.</p>
    <p><strong>Veuillez v√©rifier votre bo√Æte mail et entrer le code re√ßu ci-dessous.</strong></p>
  </div>

  <div id="codeVerificationBox" class="code-verification hidden">
    <h3>üîê V√©rification de s√©curit√©</h3>
    <p>Un code √† 6 chiffres a √©t√© envoy√© √† votre email</p>
    <input type="text" id="codeVerification" class="code-input" maxlength="6" placeholder="000000">
    <div class="error" id="errorCode">Code incorrect</div>
    <button type="button" id="btnVerifierCode">V√©rifier le code</button>
    <p style="font-size: 13px; color: #666; margin-top: 10px;">Le code est valable 10 minutes</p>
  </div>

  <div id="successMessage" class="success-message">
    <h3>‚úÖ Formulaire envoy√© avec succ√®s !</h3>
    <p>Merci pour votre inscription.</p>
  </div>

  <form id="formulaire">
    <div class="question">
      <label>Adresse e-mail <span class="required">*</span></label>
      <input type="email" id="email" required>
      <div class="error" id="errorEmail">Veuillez entrer une adresse e-mail valide</div>
    </div>
    <button type="button" id="btnVerifierEmail" style="margin-top:10px; background:#17a2b8;">V√©rifier mon e-mail</button>
    <p id="emailStatus" style="margin-top:8px; font-style:italic; color:#555;"></p>

    <div id="blocQuestions" class="hidden">
      <div class="question">
        <label>Nom <span class="required">*</span></label>
        <input type="text" id="nom" required>
      </div>

      <div class="question">
        <label>Pr√©nom <span class="required">*</span></label>
        <input type="text" id="prenom" required>
      </div>

      <div class="question">
        <label>Votre n¬∞ de t√©l√©phone professionnel (optionnel)</label>
        <input type="tel" id="telephone" placeholder="Ex: 0601020304">
        <div class="error" id="errorTelephone">Veuillez entrer un num√©ro de t√©l√©phone valide (10 chiffres)</div>
      </div>

      <div class="question">
        <label>S√©lectionner votre profession <span class="required">*</span></label>
        <select id="profession" required>
          <option value="">-- Choisir une profession --</option>
          <option value="√âducateur sp√©cialis√©">√âducateur sp√©cialis√©</option>
          <option value="Ergoth√©rapeute">Ergoth√©rapeute</option>
          <option value="Psychologue">Psychologue</option>
          <option value="Psychomotricien">Psychomotricien</option>
          <option value="Orthophoniste">Orthophoniste</option>
        </select>
      </div>

      <div class="question">
        <label>Avez-vous un num√©ro professionnel ? <span class="required">*</span></label>
        <div class="radio-group">
          <label><input type="radio" name="typeNumero" value="adeli" id="radioAdeli"> Oui, j'ai un num√©ro ADELI</label>
          <label><input type="radio" name="typeNumero" value="siret" id="radioSiret"> Oui, j'ai un num√©ro SIRET</label>
          <label><input type="radio" name="typeNumero" value="non" id="radioNon" required> Non, je n'ai pas de num√©ro</label>
        </div>
      </div>

      <div class="question hidden" id="questionAdeli">
        <label>Veuillez indiquer votre num√©ro ADELI <span class="required">*</span></label>
        <input type="text" id="numeroAdeli" maxlength="9" placeholder="9 chiffres">
        <div class="error" id="errorAdeli">Le num√©ro ADELI doit contenir exactement 9 chiffres</div>
      </div>

      <div class="question hidden" id="questionSiret">
        <label>Veuillez indiquer votre num√©ro SIRET <span class="required">*</span></label>
        <input type="text" id="numeroSiret" maxlength="14" placeholder="14 chiffres">
        <div class="error" id="errorSiret">Le num√©ro SIRET doit contenir exactement 14 chiffres</div>
      </div>

      <div id="suiteFomulaire" class="hidden">
        <div class="question">
          <label>Aupr√®s de quel(s) public(s) intervenez-vous ? <span class="required">*</span></label>
          <div class="checkbox-group" id="checkboxPublics">
            <label><input type="checkbox" value="Enfants (0-6 ans)"> Enfants (0-6 ans)</label>
            <label><input type="checkbox" value="Enfants (7-12 ans)"> Enfants (7-12 ans)</label>
            <label><input type="checkbox" value="Adolescents (12-18 ans)"> Adolescents (12-18 ans)</label>
            <label><input type="checkbox" value="Adultes (au-del√† de 18 ans)"> Adultes (au-del√† de 18 ans)</label>
          </div>
          <div class="error" id="errorPublics">Veuillez s√©lectionner au moins un public</div>
        </div>

        <div class="question">
          <label>Quels sont vos modes d'intervention ? <span class="required">*</span></label>
          <div class="checkbox-group" id="checkboxModes">
            <label><input type="checkbox" value="√Ä domicile"> √Ä domicile</label>
            <label><input type="checkbox" value="En cabinet"> En cabinet</label>
          </div>
          <div class="error" id="errorModes">Veuillez s√©lectionner au moins un mode d'intervention</div>
        </div>

        <div class="question">
          <label>Proposez-vous des rendez-vous en visio ? <span class="required">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="visio" value="Oui" required> Oui</label>
            <label><input type="radio" name="visio" value="Non"> Non</label>
          </div>
        </div>

        <div class="question">
          <label>Dans quel d√©partement intervenez-vous principalement ? <span class="required">*</span></label>
          <select id="departement" required>
            <option value="">-- Choisir un d√©partement --</option>
            <option value="54 - Meurthe-et-Moselle">54 - Meurthe-et-Moselle</option>
            <option value="55 - Meuse">55 - Meuse</option>
            <option value="57 - Moselle">57 - Moselle</option>
            <option value="88 - Vosges">88 - Vosges</option>
          </select>
        </div>

        <div class="question" style="position: relative;">
          <label>Quelle est votre commune principale d'intervention ? <span class="required">*</span></label>
          <input type="text" id="communeInput" placeholder="Commencez √† taper votre commune..." autocomplete="off" required>
          <div id="autocompleteList" class="autocomplete-items"></div>
        </div>

        <div class="question">
          <label>Quel est votre rayon d'intervention ? <span class="required">*</span></label>
          <select id="rayon" required>
            <option value="">-- Choisir un rayon --</option>
            <option value="Aucun - en cabinet">Aucun - en cabinet</option>
            <option value="10 km">10 km</option>
            <option value="15 km">15 km</option>
            <option value="20 km">20 km</option>
            <option value="25 km">25 km</option>
            <option value="30 km">30 km</option>
            <option value="40 km">40 km</option>
            <option value="50 km">50 km</option>
            <option value="Tout mon d√©partement">Tout mon d√©partement</option>
          </select>
        </div>

        <div class="question">
          <label>Avez-vous une ou des disponibilit√©s √† venir pour de nouveaux b√©n√©ficiaires ? <span class="required">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="aDisponibilite" value="Oui" id="radioDispoOui" required> Oui</label>
            <label><input type="radio" name="aDisponibilite" value="Non" id="radioDispoNon"> Non</label>
          </div>
        </div>

        <div class="question hidden" id="questionDateDispo">
          <div class="date-picker-box">
            <label>√Ä partir de quand avez-vous une disponibilit√© ? <span class="required">*</span></label>
            <input type="date" id="dateDisponibilite">
            <div class="error" id="errorDate">Veuillez s√©lectionner une date</div>
          </div>
        </div>

        <div class="question">
          <label class="consent-label">
            <input type="checkbox" id="consentement" required>
            <span>J'accepte que mes donn√©es soient utilis√©es uniquement dans le cadre de cette mise en relation <span class="required">*</span></span>
          </label>
        </div>

        <button type="submit" id="btnSubmit">Envoyer le formulaire</button>
      </div>
    </div>
  </form>
</div>

<script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbaEis0cqzKjoHIRaXZ6fcB188xhx1yB3YTLafBNO_MBZG_hhAqSui_bBvdi-lGr-F/exec';
const API_GEO_GOUV = 'https://geo.api.gouv.fr/departements';

let codeGenere = null;
let emailEnModification = null;
let estNouvelEmail = false;
let donneesUtilisateur = null;
let toutesLesCommunesDept = [];

const inputEmail = document.getElementById('email');
const btnVerifierEmail = document.getElementById('btnVerifierEmail');
const emailStatus = document.getElementById('emailStatus');
const blocQuestions = document.getElementById('blocQuestions');
const messageEmailExiste = document.getElementById('messageEmailExiste');
const messageEmailNouveau = document.getElementById('messageEmailNouveau');
const codeVerificationBox = document.getElementById('codeVerificationBox');
const inputCode = document.getElementById('codeVerification');
const btnVerifierCode = document.getElementById('btnVerifierCode');
const radioNon = document.getElementById('radioNon');
const radioAdeli = document.getElementById('radioAdeli');
const radioSiret = document.getElementById('radioSiret');
const questionAdeli = document.getElementById('questionAdeli');
const questionSiret = document.getElementById('questionSiret');
const inputAdeli = document.getElementById('numeroAdeli');
const inputSiret = document.getElementById('numeroSiret');
const suiteFomulaire = document.getElementById('suiteFomulaire');
const messageStop = document.getElementById('messageStop');
const inputTelephone = document.getElementById('telephone');
const selectDepartement = document.getElementById('departement');
const communeInput = document.getElementById('communeInput');
const autocompleteList = document.getElementById('autocompleteList');
const radioDispoOui = document.getElementById('radioDispoOui');
const radioDispoNon = document.getElementById('radioDispoNon');
const questionDateDispo = document.getElementById('questionDateDispo');
const dateDisponibilite = document.getElementById('dateDisponibilite');
const formulaire = document.getElementById('formulaire');
const btnSubmit = document.getElementById('btnSubmit');
const successMessage = document.getElementById('successMessage');

const aujourdhui = new Date().toISOString().split('T')[0];
dateDisponibilite.setAttribute('min', aujourdhui);

document.querySelectorAll('input[name="aDisponibilite"]').forEach(radio => {
  radio.addEventListener('change', function() {
    if (this.value === 'Oui') {
      questionDateDispo.classList.remove('hidden');
      dateDisponibilite.setAttribute('required', 'required');
    } else {
      questionDateDispo.classList.add('hidden');
      dateDisponibilite.removeAttribute('required');
      dateDisponibilite.value = '';
    }
  });
});

document.querySelectorAll('input[name="typeNumero"]').forEach(radio => {
  radio.addEventListener('change', function() {
    questionAdeli.classList.add('hidden');
    questionSiret.classList.add('hidden');
    suiteFomulaire.classList.add('hidden');
    messageStop.classList.add('hidden');
    inputAdeli.value = '';
    inputSiret.value = '';
    inputAdeli.removeAttribute('required');
    inputSiret.removeAttribute('required');

    if(this.value === 'non') {
      messageStop.classList.remove('hidden');
    } else if(this.value === 'adeli') { 
      questionAdeli.classList.remove('hidden'); 
      inputAdeli.setAttribute('required','required'); 
      suiteFomulaire.classList.remove('hidden'); 
    } else if(this.value === 'siret') { 
      questionSiret.classList.remove('hidden'); 
      inputSiret.setAttribute('required','required'); 
      suiteFomulaire.classList.remove('hidden'); 
    }
  });
});

inputAdeli.addEventListener('input', () => inputAdeli.value = inputAdeli.value.replace(/\D/g, ''));
inputSiret.addEventListener('input', () => inputSiret.value = inputSiret.value.replace(/\D/g, ''));
inputTelephone.addEventListener('input', () => inputTelephone.value = inputTelephone.value.replace(/\D/g, ''));
inputCode.addEventListener('input', () => inputCode.value = inputCode.value.replace(/\D/g, ''));

async function preremplirFormulaire(userData) {
  console.log('üîÑ Pr√©-remplissage:', userData);
  
  if (!userData) return;

  function getVal(key1, key2) {
    return userData[key1] || userData[key2] || userData[key1.toLowerCase()] || 
           userData[key1.toLowerCase().replace(/\s+/g, '')] || '';
  }

  const nom = getVal('Nom', 'nom');
  const prenom = getVal('Pr√©nom', 'prenom');
  const telephone = getVal('T√©l√©phone', 'telephone');
  const profession = getVal('Profession', 'profession');
  
  if (nom) document.getElementById('nom').value = nom;
  if (prenom) document.getElementById('prenom').value = prenom;
  if (telephone) document.getElementById('telephone').value = telephone;
  if (profession) document.getElementById('profession').value = profession;

  const typeNumero = getVal('Type Num√©ro', 'typenumero');
  console.log('üîë Type Num√©ro:', typeNumero);
  
  if (typeNumero === 'adeli') {
    radioAdeli.checked = true;
    questionAdeli.classList.remove('hidden');
    suiteFomulaire.classList.remove('hidden');
    inputAdeli.setAttribute('required', 'required');
    const adeliNum = getVal('Num√©ro ADELI', 'numeroadeli');
    if (adeliNum) inputAdeli.value = adeliNum;
  } else if (typeNumero === 'siret') {
    radioSiret.checked = true;
    questionSiret.classList.remove('hidden');
    suiteFomulaire.classList.remove('hidden');
    inputSiret.setAttribute('required', 'required');
    const siretNum = getVal('Num√©ro SIRET', 'numerosiret');
    if (siretNum) inputSiret.value = siretNum;
  } else if (typeNumero === 'non') {
    radioNon.checked = true;
    messageStop.classList.remove('hidden');
  }

  const publics = getVal('Publics', 'publics');
  if (publics) {
    const publicsList = publics.split(', ');
    document.querySelectorAll('#checkboxPublics input[type="checkbox"]').forEach(cb => {
      if (publicsList.includes(cb.value)) cb.checked = true;
    });
  }

  const modes = getVal('Modes Intervention', 'modesintervention');
  if (modes) {
    const modesList = modes.split(', ');
    document.querySelectorAll('#checkboxModes input[type="checkbox"]').forEach(cb => {
      if (modesList.includes(cb.value)) cb.checked = true;
    });
  }

  const visio = getVal('Visio', 'visio');
  if (visio) {
    document.querySelectorAll('input[name="visio"]').forEach(radio => {
      if (radio.value === visio) radio.checked = true;
    });
  }

  const departement = getVal('D√©partement', 'departement');
  if (departement) {
    selectDepartement.value = departement;
    
    const commune = getVal('Commune', 'commune');
    if (commune) {
      const numDept = departement.split(' ')[0];
      communeInput.placeholder = '‚è≥ Chargement...';
      communeInput.disabled = true;

      try {
        const resp = await fetch(`${API_GEO_GOUV}/${numDept}/communes`);
        if (resp.ok) {
          const communes = await resp.json();
          communes.sort((a, b) => a.nom.localeCompare(b.nom));
          toutesLesCommunesDept = communes;
          communeInput.value = commune;
          communeInput.disabled = false;
          communeInput.placeholder = 'Commencez √† taper...';
        }
      } catch (e) {
        console.error('Erreur communes:', e);
        communeInput.disabled = false;
      }
    }
  }

  const rayon = getVal('Rayon', 'rayon');
  if (rayon) document.getElementById('rayon').value = rayon;

  const aDispo = getVal('A Disponibilit√©', 'adisponibilite');
  if (aDispo) {
    if (aDispo === 'Oui') {
      radioDispoOui.checked = true;
      questionDateDispo.classList.remove('hidden');
      dateDisponibilite.setAttribute('required', 'required');
      
      const dateDispo = getVal('Date Disponibilit√©', 'datedisponibilite');
      if (dateDispo) {
        if (dateDispo.includes('/')) {
          const [j, m, a] = dateDispo.split('/');
          dateDisponibilite.value = `${a}-${m.padStart(2,'0')}-${j.padStart(2,'0')}`;
        } else {
          dateDisponibilite.value = dateDispo;
        }
      }
    } else {
      radioDispoNon.checked = true;
    }
  }

  document.getElementById('consentement').checked = true;
  console.log('‚úÖ Pr√©-remplissage termin√©');
}

inputEmail.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    btnVerifierEmail.click();
  }
});

btnVerifierEmail.addEventListener('click', async function() {
  const email = inputEmail.value.trim();

  if (!email || !email.includes('@')) {
    alert("‚ö†Ô∏è Veuillez entrer une adresse e-mail valide.");
    return;
  }

  btnVerifierEmail.disabled = true;
  btnVerifierEmail.textContent = "‚è≥ V√©rification...";
  emailStatus.textContent = "V√©rification en cours...";
  
  blocQuestions.classList.add('hidden');
  messageEmailExiste.classList.add('hidden');
  messageEmailNouveau.classList.add('hidden');
  codeVerificationBox.classList.add('hidden');

  try {
    const url = `${GOOGLE_SCRIPT_URL}?action=verifierEmail&email=${encodeURIComponent(email)}`;
    console.log('üåê Appel:', url);
    
    const response = await fetch(url);
    const result = await response.json();
    
    console.log('üì¶ R√©ponse:', result);

    codeGenere = result.code;
    donneesUtilisateur = result.userData || null;

    if (result.existe) {
      emailEnModification = email;
      estNouvelEmail = false;
      messageEmailExiste.classList.remove('hidden');
      codeVerificationBox.classList.remove('hidden');
      emailStatus.textContent = "‚ö†Ô∏è Email existant. Code envoy√©.";
      console.log('‚úÖ Donn√©es r√©cup√©r√©es:', donneesUtilisateur);
    } else {
      estNouvelEmail = true;
      donneesUtilisateur = null;
      messageEmailNouveau.classList.remove('hidden');
      codeVerificationBox.classList.remove('hidden');
      emailStatus.textContent = "‚úÖ Nouvel email. Code envoy√©.";
    }
  } catch (error) {
    console.error('‚ùå Erreur:', error);
    emailStatus.textContent = "‚ùå Erreur de v√©rification.";
  }

  btnVerifierEmail.disabled = false;
  btnVerifierEmail.textContent = "V√©rifier mon e-mail";
});

selectDepartement.addEventListener('change', async function() {
  const dept = this.value;
  autocompleteList.innerHTML = '';
  toutesLesCommunesDept = [];

  if(!dept) return;
  
  const numDept = dept.split(' ')[0];
  communeInput.placeholder = '‚è≥ Chargement...';
  communeInput.disabled = true;

  try {
    const resp = await fetch(`${API_GEO_GOUV}/${numDept}/communes`);
    if (!resp.ok) throw new Error('Erreur API');
    
    const communes = await resp.json();
    communes.sort((a, b) => a.nom.localeCompare(b.nom));
    toutesLesCommunesDept = communes;
    
    communeInput.placeholder
