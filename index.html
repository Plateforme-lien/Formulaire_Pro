<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inscription Professionnels</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
<style>
* { box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f0f4f8;
  padding: 20px;
  margin: 0;
}
.container {
  max-width: 700px;
  margin: 0 auto;
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
h1 { color: #2c3e50; margin-bottom: 10px; font-size: 28px; }
.subtitle { color: #7f8c8d; margin-bottom: 30px; font-size: 15px; }
.question { margin-bottom: 25px; }
label { display: block; font-weight: 600; margin-bottom: 8px; color: #34495e; font-size: 15px; }
.required { color: #e74c3c; }
input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e6ed;
  border-radius: 6px;
  font-size: 15px;
  transition: border-color 0.3s;
}
input:focus, select:focus { outline: none; border-color: #3498db; }
input[readonly] { background-color: #f3f6f9; }
.checkbox-group, .radio-group { margin-top: 8px; }
.checkbox-group label, .radio-group label { 
  display: flex; align-items: center; font-weight: normal; 
  margin-bottom: 8px; cursor: pointer; 
}
input[type="checkbox"], input[type="radio"] { 
  margin-right: 8px; cursor: pointer; width: 18px; height: 18px; 
}
.hidden { display: none; }
.alert-box {
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  border: 2px solid;
}
.alert-info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
.alert-success { background: #d4edda; border-color: #28a745; color: #155724; }
.alert-warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
.alert-box h3 { margin-top: 0; }
.code-box {
  background: #e7f3ff;
  border: 2px solid #2196F3;
  border-radius: 8px;
  padding: 25px;
  margin: 20px 0;
  text-align: center;
}
.code-box h3 { color: #1976D2; margin-top: 0; }
.code-input {
  width: 220px;
  text-align: center;
  font-size: 24px;
  letter-spacing: 8px;
  font-weight: bold;
  margin: 15px 0;
  padding: 12px;
}
button {
  width: 100%;
  padding: 14px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
  margin-top: 15px;
}
button:hover { background: #2980b9; }
button:disabled { background: #95a5a6; cursor: not-allowed; }
.btn-secondary { background: #17a2b8; }
.btn-secondary:hover { background: #138496; }
.error-msg { color: #e74c3c; font-size: 13px; margin-top: 5px; display: none; }
.error-msg.show { display: block; }
.autocomplete-list {
  position: absolute;
  background: white;
  border: 1px solid #d4d4d4;
  border-top: none;
  z-index: 99;
  max-height: 150px;
  overflow-y: auto;
  width: 100%;
}
.autocomplete-item {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
}
.autocomplete-item:hover { background-color: #e9e9e9; }
.section-title {
  background: #f8f9fa;
  padding: 15px;
  border-left: 4px solid #3498db;
  margin: 30px 0 20px 0;
  font-size: 18px;
  font-weight: 600;
  color: #2c3e50;
}
</style>
</head>
<body>

<div class="container">
  <h1>üìã Inscription Professionnels</h1>
  <p class="subtitle">Formulaire d'inscription pour les professionnels de sant√©</p>

  <!-- √âTAPE 1 : EMAIL (HORS FORMULAIRE) -->
  <div id="etapeEmail">
    <div class="question">
      <label>Adresse e-mail <span class="required">*</span></label>
      <input type="email" id="inputEmail" placeholder="votre.email@exemple.com">
      <div class="error-msg" id="errorEmail">Veuillez entrer une adresse e-mail valide</div>
    </div>
    <button type="button" id="btnVerifierEmail" class="btn-secondary">V√©rifier mon e-mail</button>
    <div id="statusEmail" style="margin-top:15px; font-size:14px; color:#666;"></div>
  </div>

  <!-- √âTAPE 2 : CODE V√âRIFICATION (HORS FORMULAIRE) -->
  <div id="etapeCode" class="hidden">
    <div class="code-box">
      <h3>üîê V√©rification de s√©curit√©</h3>
      <p>Un code √† 6 chiffres a √©t√© envoy√© √† votre email</p>
      <input type="text" id="inputCode" class="code-input" maxlength="6" placeholder="000000">
      <div class="error-msg" id="errorCode">Code incorrect</div>
      <button type="button" id="btnVerifierCode">V√©rifier le code</button>
      <p style="font-size: 13px; color: #666; margin-top: 10px;">Le code est valable 10 minutes</p>
    </div>
  </div>

  <!-- √âTAPE 3 : FORMULAIRE -->
  <form id="formulaire" class="hidden">
    
    <div id="alertExistant" class="alert-box alert-info hidden">
      <h3>üìù Modification de vos informations</h3>
      <p>Vos donn√©es actuelles sont pr√©-remplies. Vous pouvez les modifier et enregistrer.</p>
    </div>

    <div id="alertNouveau" class="alert-box alert-success hidden">
      <h3>‚úÖ Nouvelle inscription</h3>
      <p>Remplissez le formulaire ci-dessous pour vous inscrire.</p>
    </div>

    <!-- Section Informations personnelles -->
    <div class="section-title">üë§ Informations personnelles</div>
    
    <div class="question">
      <label>Nom <span class="required">*</span></label>
      <input type="text" name="Nom" id="nom">
    </div>

    <div class="question">
      <label>Pr√©nom <span class="required">*</span></label>
      <input type="text" name="Pr√©nom" id="prenom">
    </div>

    <div class="question">
      <label>T√©l√©phone professionnel (optionnel)</label>
      <input type="tel" name="T√©l√©phone" id="telephone" placeholder="0601020304">
      <div class="error-msg" id="errorTelephone">Format incorrect (10 chiffres)</div>
    </div>

    <div class="question">
      <label>Profession <span class="required">*</span></label>
      <select name="Profession" id="profession">
        <option value="">-- Choisir --</option>
        <option value="√âducateur sp√©cialis√©">√âducateur sp√©cialis√©</option>
        <option value="Ergoth√©rapeute">Ergoth√©rapeute</option>
        <option value="Psychologue">Psychologue</option>
        <option value="Psychomotricien">Psychomotricien</option>
        <option value="Orthophoniste">Orthophoniste</option>
      </select>
    </div>

    <!-- Section Num√©ro professionnel -->
    <div class="section-title">üî¢ Num√©ro professionnel</div>

    <div class="question">
      <label>Type de num√©ro <span class="required">*</span></label>
      <div class="radio-group">
        <label><input type="radio" name="Type Num√©ro" value="adeli" id="radioAdeli"> Num√©ro ADELI</label>
        <label><input type="radio" name="Type Num√©ro" value="siret" id="radioSiret"> Num√©ro SIRET</label>
        <label><input type="radio" name="Type Num√©ro" value="non" id="radioNon"> Aucun</label>
      </div>
    </div>

    <div class="question hidden" id="questionAdeli">
      <label>Num√©ro ADELI (9 chiffres) <span class="required">*</span></label>
      <input type="text" name="Num√©ro ADELI" id="numeroAdeli" maxlength="9">
      <div class="error-msg" id="errorAdeli">9 chiffres requis</div>
    </div>

    <div class="question hidden" id="questionSiret">
      <label>Num√©ro SIRET (14 chiffres) <span class="required">*</span></label>
      <input type="text" name="Num√©ro SIRET" id="numeroSiret" maxlength="14">
      <div class="error-msg" id="errorSiret">14 chiffres requis</div>
    </div>

    <!-- Section cach√©e pour nouveaux utilisateurs sans num√©ro -->
    <div id="blocSansNumero" class="hidden">
      <div class="alert-box alert-warning">
        <h3>‚ö†Ô∏è Num√©ro professionnel requis</h3>
        <p>Ce formulaire est r√©serv√© aux professionnels avec num√©ro ADELI ou SIRET.</p>
      </div>
    </div>

    <!-- Section Activit√© (cach√©e si "non") -->
    <div id="sectionActivite" class="hidden">
      
      <div class="section-title">üë• Publics et modes d'intervention</div>

      <div class="question">
        <label>Publics <span class="required">*</span></label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="Publics" value="Enfants (0-6 ans)"> Enfants (0-6 ans)</label>
          <label><input type="checkbox" name="Publics" value="Enfants (7-12 ans)"> Enfants (7-12 ans)</label>
          <label><input type="checkbox" name="Publics" value="Adolescents (12-18 ans)"> Adolescents (12-18 ans)</label>
          <label><input type="checkbox" name="Publics" value="Adultes (au-del√† de 18 ans)"> Adultes (au-del√† de 18 ans)</label>
        </div>
        <div class="error-msg" id="errorPublics">S√©lectionnez au moins un public</div>
      </div>

      <div class="question">
        <label>Modes d'intervention <span class="required">*</span></label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="Modes Intervention" value="√Ä domicile"> √Ä domicile</label>
          <label><input type="checkbox" name="Modes Intervention" value="En cabinet"> En cabinet</label>
        </div>
        <div class="error-msg" id="errorModes">S√©lectionnez au moins un mode</div>
      </div>

      <div class="question">
        <label>Rendez-vous en visio ? <span class="required">*</span></label>
        <div class="radio-group">
          <label><input type="radio" name="Visio" value="Oui"> Oui</label>
          <label><input type="radio" name="Visio" value="Non"> Non</label>
        </div>
      </div>

      <div class="section-title">üìç Localisation</div>

      <div class="question">
        <label>D√©partement principal <span class="required">*</span></label>
        <select name="D√©partement" id="departement">
          <option value="">-- Choisir --</option>
          <option value="54 - Meurthe-et-Moselle">54 - Meurthe-et-Moselle</option>
          <option value="55 - Meuse">55 - Meuse</option>
          <option value="57 - Moselle">57 - Moselle</option>
          <option value="88 - Vosges">88 - Vosges</option>
        </select>
      </div>

      <div class="question" style="position: relative;">
        <label>Commune principale <span class="required">*</span></label>
        <input type="text" name="Commune" id="commune" placeholder="Tapez votre commune..." autocomplete="off">
        <div id="autocompleteList" class="autocomplete-list"></div>
      </div>

      <div class="question">
        <label>Rayon d'intervention <span class="required">*</span></label>
        <select name="Rayon" id="rayon">
          <option value="">-- Choisir --</option>
          <option value="Aucun - en cabinet">Aucun - en cabinet</option>
          <option value="10 km">10 km</option>
          <option value="15 km">15 km</option>
          <option value="20 km">20 km</option>
          <option value="25 km">25 km</option>
          <option value="30 km">30 km</option>
          <option value="40 km">40 km</option>
          <option value="50 km">50 km</option>
          <option value="Tout mon d√©partement">Tout mon d√©partement</option>
        </select>
      </div>

      <div class="section-title">üìÖ Disponibilit√©s</div>

      <div class="question">
        <label>Disponibilit√©s pour nouveaux b√©n√©ficiaires ? <span class="required">*</span></label>
        <div class="radio-group">
          <label><input type="radio" name="A Disponibilit√©" value="Oui" id="dispoOui"> Oui</label>
          <label><input type="radio" name="A Disponibilit√©" value="Non" id="dispoNon"> Non</label>
        </div>
      </div>

      <div class="question hidden" id="questionDateDispo">
        <label>√Ä partir de quand ? <span class="required">*</span></label>
        <input type="date" name="Date Disponibilit√©" id="dateDispo">
        <div class="error-msg" id="errorDate">Date requise</div>
      </div>

      <div class="section-title">‚úÖ Consentement</div>

      <div class="question">
        <label style="display: flex; align-items: flex-start; gap: 8px; font-weight: normal;">
          <input type="checkbox" name="Consentement" id="consentement" style="margin-top: 3px;">
          <span>J'accepte que mes donn√©es soient utilis√©es uniquement dans le cadre de cette mise en relation <span class="required">*</span></span>
        </label>
      </div>

    </div>

    <button type="submit" id="btnEnvoyer">Envoyer le formulaire</button>
  </form>

  <!-- Message succ√®s -->
  <div id="messageSucces" class="alert-box alert-success hidden">
    <h3>‚úÖ Formulaire envoy√© avec succ√®s !</h3>
    <p>Merci pour votre inscription.</p>
  </div>

</div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwom8SGhiURX5a7tGwZqqZ-3sJVmsvqI4rleLLzyu2jpskMhJr6lkSeNVbuRDtVTgjHIw/exec';
const API_COMMUNES = 'https://geo.api.gouv.fr/departements';
const MODE_LOCAL = location.protocol === 'file:';

console.log(MODE_LOCAL ? 'üíª MODE LOCAL' : 'üåê MODE PRODUCTION');

// ============================================
// VARIABLES GLOBALES
// ============================================
let codeAttendu = null;
let emailUtilisateur = null;
let estEmailExistant = false;
let donneesExistantes = null;
let communesDept = [];

// ============================================
// √âL√âMENTS DOM
// ============================================
const $ = id => document.getElementById(id);
const etapeEmail = $('etapeEmail');
const etapeCode = $('etapeCode');
const formulaire = $('formulaire');
const inputEmail = $('inputEmail');
const btnVerifierEmail = $('btnVerifierEmail');
const statusEmail = $('statusEmail');
const inputCode = $('inputCode');
const btnVerifierCode = $('btnVerifierCode');
const alertExistant = $('alertExistant');
const alertNouveau = $('alertNouveau');
const radioAdeli = $('radioAdeli');
const radioSiret = $('radioSiret');
const radioNon = $('radioNon');
const questionAdeli = $('questionAdeli');
const questionSiret = $('questionSiret');
const blocSansNumero = $('blocSansNumero');
const sectionActivite = $('sectionActivite');
const numeroAdeli = $('numeroAdeli');
const numeroSiret = $('numeroSiret');
const telephone = $('telephone');
const departement = $('departement');
const commune = $('commune');
const autocompleteList = $('autocompleteList');
const dispoOui = $('dispoOui');
const dispoNon = $('dispoNon');
const questionDateDispo = $('questionDateDispo');
const dateDispo = $('dateDispo');

// Date minimum = aujourd'hui
dateDispo.min = new Date().toISOString().split('T')[0];

// ============================================
// √âTAPE 1 : V√âRIFICATION EMAIL
// ============================================
inputEmail.addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    btnVerifierEmail.click();
  }
});

btnVerifierEmail.addEventListener('click', async () => {
  const email = inputEmail.value.trim().toLowerCase();
  
  if (!email || !email.includes('@')) {
    $('errorEmail').classList.add('show');
    return;
  }
  
  $('errorEmail').classList.remove('show');
  btnVerifierEmail.disabled = true;
  btnVerifierEmail.textContent = '‚è≥ V√©rification...';
  statusEmail.textContent = 'V√©rification en cours...';

  try {
    if (MODE_LOCAL) {
      // MODE TEST
      await new Promise(r => setTimeout(r, 1000));
      const testExistant = false; // Changez en true pour tester email existant
      codeAttendu = '123456';
      emailUtilisateur = email;
      
      if (testExistant) {
        estEmailExistant = true;
        donneesExistantes = {
          'Nom': 'Dupont',
          'Pr√©nom': 'Marie',
          'T√©l√©phone': '0601020304',
          'Profession': 'Psychologue',
          'Type Num√©ro': 'adeli',
          'Num√©ro ADELI': '123456789',
          'Publics': 'Enfants (0-6 ans), Adultes (au-del√† de 18 ans)',
          'Modes Intervention': '√Ä domicile, En cabinet',
          'Visio': 'Oui',
          'D√©partement': '54 - Meurthe-et-Moselle',
          'Commune': 'Nancy',
          'Rayon': '20 km',
          'A Disponibilit√©': 'Oui',
          'Date Disponibilit√©': '15/12/2025'
        };
      } else {
        estEmailExistant = false;
        donneesExistantes = null;
      }
      
      statusEmail.innerHTML = `‚úÖ ${estEmailExistant ? 'Email existant' : 'Nouvel email'} - Code TEST: <strong>123456</strong>`;
    } else {
      // MODE PRODUCTION
      const res = await fetch(`${SCRIPT_URL}?action=verifierEmail&email=${encodeURIComponent(email)}`);
      const data = await res.json();
      
      console.log('üì¶ R√©ponse serveur:', data);
      
      if (data.error) {
        statusEmail.textContent = '‚ùå ' + data.error;
        btnVerifierEmail.disabled = false;
        btnVerifierEmail.textContent = 'V√©rifier mon e-mail';
        return;
      }
      
      codeAttendu = data.code;
      emailUtilisateur = email;
      estEmailExistant = data.existe;
      donneesExistantes = data.userData || null;
      
      statusEmail.textContent = `‚úÖ Code envoy√© √† ${email}`;
    }
    
    // Afficher l'√©tape code
    etapeCode.classList.remove('hidden');
    inputEmail.readOnly = true;
    btnVerifierEmail.style.display = 'none';
    
  } catch (error) {
    console.error('Erreur:', error);
    statusEmail.textContent = '‚ùå Erreur de connexion';
    btnVerifierEmail.disabled = false;
    btnVerifierEmail.textContent = 'V√©rifier mon e-mail';
  }
});

// ============================================
// √âTAPE 2 : V√âRIFICATION CODE
// ============================================
inputCode.addEventListener('input', () => {
  inputCode.value = inputCode.value.replace(/\D/g, '');
});

btnVerifierCode.addEventListener('click', () => {
  const code = inputCode.value.trim();
  
  if (code.length !== 6) {
    $('errorCode').textContent = 'Le code doit contenir 6 chiffres';
    $('errorCode').classList.add('show');
    return;
  }
  
  if (MODE_LOCAL) codeAttendu = code; // En test, accepter tout code
  
  if (code === codeAttendu) {
    $('errorCode').classList.remove('show');
    etapeCode.classList.add('hidden');
    formulaire.classList.remove('hidden');
    
    if (estEmailExistant) {
      // EMAIL EXISTANT : Tout visible + pr√©-rempli
      alertExistant.classList.remove('hidden');
      alertNouveau.classList.add('hidden');
      preremplirFormulaire();
      afficherToutesLesSections();
    } else {
      // NOUVEL EMAIL : Sections progressives
      alertExistant.classList.add('hidden');
      alertNouveau.classList.remove('hidden');
      activerSectionsProgressives();
    }
  } else {
    $('errorCode').textContent = 'Code incorrect';
    $('errorCode').classList.add('show');
  }
});

// ============================================
// AFFICHAGE : EMAIL EXISTANT
// ============================================
function afficherToutesLesSections() {
  // Tout visible d'un coup
  sectionActivite.classList.remove('hidden');
  // Les sections conditionnelles seront g√©r√©es par les events listeners
}

function preremplirFormulaire() {
  if (!donneesExistantes) return;
  
  console.log('üîÑ Pr√©-remplissage:', donneesExistantes);
  
  // Infos de base
  if (donneesExistantes['Nom']) $('nom').value = donneesExistantes['Nom'];
  if (donneesExistantes['Pr√©nom']) $('prenom').value = donneesExistantes['Pr√©nom'];
  if (donneesExistantes['T√©l√©phone']) $('telephone').value = donneesExistantes['T√©l√©phone'];
  if (donneesExistantes['Profession']) $('profession').value = donneesExistantes['Profession'];
  
  // Type num√©ro
  const typeNum = donneesExistantes['Type Num√©ro'];
  if (typeNum === 'adeli') {
    radioAdeli.checked = true;
    questionAdeli.classList.remove('hidden');
    sectionActivite.classList.remove('hidden');
    if (donneesExistantes['Num√©ro ADELI']) numeroAdeli.value = donneesExistantes['Num√©ro ADELI'];
  } else if (typeNum === 'siret') {
    radioSiret.checked = true;
    questionSiret.classList.remove('hidden');
    sectionActivite.classList.remove('hidden');
    if (donneesExistantes['Num√©ro SIRET']) numeroSiret.value = donneesExistantes['Num√©ro SIRET'];
  } else if (typeNum === 'non') {
    radioNon.checked = true;
  }
  
  // Publics (checkboxes)
  if (donneesExistantes['Publics']) {
    const publics = donneesExistantes['Publics'].split(', ');
    document.querySelectorAll('input[name="Publics"]').forEach(cb => {
      if (publics.includes(cb.value)) cb.checked = true;
    });
  }
  
  // Modes intervention
  if (donneesExistantes['Modes Intervention']) {
    const modes = donneesExistantes['Modes Intervention'].split(', ');
    document.querySelectorAll('input[name="Modes Intervention"]').forEach(cb => {
      if (modes.includes(cb.value)) cb.checked = true;
    });
  }
  
  // Visio
  if (donneesExistantes['Visio']) {
    document.querySelectorAll('input[name="Visio"]').forEach(r => {
      if (r.value === donneesExistantes['Visio']) r.checked = true;
    });
  }
  
  // D√©partement et commune
  if (donneesExistantes['D√©partement']) {
    departement.value = donneesExistantes['D√©partement'];
    departement.dispatchEvent(new Event('change'));
  }
  
  if (donneesExistantes['Rayon']) $('rayon').value = donneesExistantes['Rayon'];
  
  // Disponibilit√©
  if (donneesExistantes['A Disponibilit√©']) {
    if (donneesExistantes['A Disponibilit√©'] === 'Oui') {
      dispoOui.checked = true;
      questionDateDispo.classList.remove('hidden');
      
      if (donneesExistantes['Date Disponibilit√©']) {
        const dateStr = donneesExistantes['Date Disponibilit√©'];
        if (dateStr.includes('/')) {
          const [j, m, a] = dateStr.split('/');
          dateDispo.value = `${a}-${m}-${j}`;
        } else {
          dateDispo.value = dateStr;
        }
      }
    } else {
      dispoNon.checked = true;
    }
  }
  
  // Consentement
  $('consentement').checked = true;
}

// ============================================
// SECTIONS PROGRESSIVES : NOUVEL EMAIL
// ============================================
function activerSectionsProgressives() {
  // Au d√©part, section activit√© cach√©e
  sectionActivite.classList.add('hidden');
  
  // √âcoute changement type num√©ro
  document.querySelectorAll('input[name="Type Num√©ro"]').forEach(radio => {
    radio.addEventListener('change', gererTypeNumero);
  });
}

function gererTypeNumero() {
  questionAdeli.classList.add('hidden');
  questionSiret.classList.add('hidden');
  blocSansNumero.classList.add('hidden');
  sectionActivite.classList.add('hidden');
  numeroAdeli.value = '';
  numeroSiret.value = '';
  
  if (radioAdeli.checked) {
    questionAdeli.classList.remove('hidden');
    sectionActivite.classList.remove('hidden');
  } else if (radioSiret.checked) {
    questionSiret.classList.remove('hidden');
    sectionActivite.classList.remove('hidden');
  } else if (radioNon.checked) {
    blocSansNumero.classList.remove('hidden');
  }
}

// ============================================
// GESTION DISPONIBILIT√â
// ============================================
document.querySelectorAll('input[name="A Disponibilit√©"]').forEach(radio => {
  radio.addEventListener('change', function() {
    if (this.value === 'Oui') {
      questionDateDispo.classList.remove('hidden');
    } else {
      questionDateDispo.classList.add('hidden');
      dateDispo.value = '';
    }
  });
});

// ============================================
// VALIDATION CHAMPS NUM√âRIQUES
// ============================================
numeroAdeli.addEventListener('input', () => {
  numeroAdeli.value = numeroAdeli.value.replace(/\D/g, '');
});

numeroSiret.addEventListener('input', () => {
  numeroSiret.value = numeroSiret.value.replace(/\D/g, '');
});

telephone.addEventListener('input', () => {
  telephone.value = telephone.value.replace(/\D/g, '');
});

// ============================================
// AUTOCOMPLETE COMMUNES
// ============================================
departement.addEventListener('change', async function() {
  const dept = this.value;
  const communeActuelle = commune.value;
  autocompleteList.innerHTML = '';
  communesDept = [];
  
  if (!dept) return;
  
  const numDept = dept.split(' ')[0];
  commune.placeholder = '‚è≥ Chargement...';
  commune.disabled = true;
  
  try {
    const res = await fetch(`${API_COMMUNES}/${numDept}/communes`);
    const communes = await res.json();
    communes.sort((a, b) => a.nom.localeCompare(b.nom));
    communesDept = communes;
    commune.placeholder = 'Tapez votre commune...';
    commune.disabled = false;
    
    // Restaurer commune si pr√©-remplissage
    if (donneesExistantes && donneesExistantes['Commune'] && !communeActuelle) {
      commune.value = donneesExistantes['Commune'];
    } else if (communeActuelle) {
      commune.value = communeActuelle;
    }
  } catch (error) {
    console.error('Erreur communes:', error);
    commune.placeholder = 'Erreur...';
    commune.disabled = false;
  }
});

commune.addEventListener('input', function() {
  const val = this.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  autocompleteList.innerHTML = '';
  
  if (!val) return;
  
  const filtered = communesDept.filter(c => {
    const nom = c.nom.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return nom.includes(val);
  });
  
  filtered.slice(0, 10).forEach(c => {
    const div = document.createElement('div');
    div.className = 'autocomplete-item';
    div.textContent = c.nom;
    div.addEventListener('click', () => {
      commune.value = c.nom;
      autocompleteList.innerHTML = '';
    });
    autocompleteList.appendChild(div);
  });
});

document.addEventListener('click', e => {
  if (e.target !== commune) autocompleteList.innerHTML = '';
});

// ============================================
// SOUMISSION FORMULAIRE
// ============================================
formulaire.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // R√©initialiser erreurs
  document.querySelectorAll('.error-msg').forEach(el => el.classList.remove('show'));
  
  let isValid = true;
  
  // Validation formulaire
  let isValid = true;
  
  // Nom
  if (!$('nom').value.trim()) {
    alert('Veuillez entrer votre nom');
    isValid = false;
  }
  
  // Pr√©nom
  if (!$('prenom').value.trim()) {
    alert('Veuillez entrer votre pr√©nom');
    isValid = false;
  }
  
  // Profession
  if (!$('profession').value) {
    alert('Veuillez s√©lectionner votre profession');
    isValid = false;
  }
  
  // Validation t√©l√©phone
  const tel = telephone.value.trim();
  if (tel && tel.length !== 10) {
    $('errorTelephone').classList.add('show');
    isValid = false;
  }
  
  // Validation type num√©ro
  const typeNumChecked = document.querySelector('input[name="Type Num√©ro"]:checked');
  if (!typeNumChecked) {
    alert('Veuillez s√©lectionner un type de num√©ro professionnel');
    isValid = false;
  }
  
  // Validation ADELI
  if (radioAdeli.checked && numeroAdeli.value.length !== 9) {
    $('errorAdeli').classList.add('show');
    isValid = false;
  }
  
  // Validation SIRET
  if (radioSiret.checked && numeroSiret.value.length !== 14) {
    $('errorSiret').classList.add('show');
    isValid = false;
  }
  
  // Si "non" s√©lectionn√©, pas de validation des sections suivantes
  if (radioNon.checked) {
    if (!isValid) return;
    // Pas d'envoi pour "non"
    alert('‚ö†Ô∏è Ce formulaire est r√©serv√© aux professionnels avec num√©ro ADELI ou SIRET.');
    return;
  }
  
  // Validation sections activit√© (seulement si adeli/siret)
  const publicsChecked = document.querySelectorAll('input[name="Publics"]:checked');
  if (publicsChecked.length === 0) {
    $('errorPublics').classList.add('show');
    isValid = false;
  }
  
  const modesChecked = document.querySelectorAll('input[name="Modes Intervention"]:checked');
  if (modesChecked.length === 0) {
    $('errorModes').classList.add('show');
    isValid = false;
  }
  
  const visioChecked = document.querySelector('input[name="Visio"]:checked');
  if (!visioChecked) {
    alert('Veuillez indiquer si vous proposez la visio');
    isValid = false;
  }
  
  if (!departement.value) {
    alert('Veuillez s√©lectionner un d√©partement');
    isValid = false;
  }
  
  if (!commune.value.trim()) {
    alert('Veuillez indiquer votre commune');
    isValid = false;
  }
  
  if (!$('rayon').value) {
    alert('Veuillez s√©lectionner un rayon');
    isValid = false;
  }
  
  const dispoChecked = document.querySelector('input[name="A Disponibilit√©"]:checked');
  if (!dispoChecked) {
    alert('Veuillez indiquer vos disponibilit√©s');
    isValid = false;
  }
  
  if (dispoOui.checked && !dateDispo.value) {
    $('errorDate').classList.add('show');
    isValid = false;
  }
  
  if (!$('consentement').checked) {
    alert('Veuillez accepter le consentement');
    isValid = false;
  }
  
  if (!isValid) return;
  
  // Pr√©paration des donn√©es
  const formData = new FormData(this);
  const now = new Date();
  const horodateur = new Intl.DateTimeFormat('fr-FR', {
    timeZone: 'Europe/Paris',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  }).format(now);
  
  const data = {
    Horodateur: horodateur,
    Email: emailUtilisateur,
    codeVerifie: 'oui',
    'Statut Email': estEmailExistant ? 'Modification - Email existant v√©rifi√©' : 'Nouvel email v√©rifi√©'
  };
  
  // Collecter les donn√©es du formulaire
  for (let [key, value] of formData.entries()) {
    if (data[key]) {
      // G√©rer les checkboxes multiples
      if (Array.isArray(data[key])) {
        data[key].push(value);
      } else {
        data[key] = [data[key], value];
      }
    } else {
      data[key] = value;
    }
  }
  
  // Formater les tableaux
  if (Array.isArray(data.Publics)) {
    data.Publics = data.Publics.join(', ');
  }
  if (Array.isArray(data['Modes Intervention'])) {
    data['Modes Intervention'] = data['Modes Intervention'].join(', ');
  }
  
  // Formater consentement
  if (data.Consentement === 'on') {
    data.Consentement = "J'accepte";
  }
  
  console.log('üì§ Donn√©es √† envoyer:', data);
  
  // Envoi
  const btnEnvoyer = $('btnEnvoyer');
  btnEnvoyer.disabled = true;
  btnEnvoyer.textContent = '‚è≥ Envoi en cours...';
  
  try {
    if (MODE_LOCAL) {
      // Mode test
      await new Promise(r => setTimeout(r, 1500));
      console.log('‚úÖ SIMULATION - Donn√©es enregistr√©es');
    } else {
      // Mode production
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain' },
        redirect: 'follow'
      });
      
      const text = await res.text();
      console.log('üì© R√©ponse brute:', text);
      
      const response = JSON.parse(text);
      
      if (response.result === 'error') {
        throw new Error(response.message || 'Erreur serveur');
      }
      
      console.log('‚úÖ Formulaire envoy√©:', response);
    }
    
    // Succ√®s
    formulaire.classList.add('hidden');
    $('messageSucces').classList.remove('hidden');
    $('messageSucces').scrollIntoView({ behavior: 'smooth' });
    
    // R√©initialisation
    setTimeout(() => {
      location.reload();
    }, 3000);
    
  } catch (error) {
    console.error('‚ùå Erreur:', error);
    alert('‚ùå Erreur lors de l\'envoi : ' + error.message);
    btnEnvoyer.disabled = false;
    btnEnvoyer.textContent = 'Envoyer le formulaire';
  }
});

console.log('‚úÖ Script initialis√©');
</script>
</body>
</html>
