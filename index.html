<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inscription Professionnels - Plateforme</title>
<link rel="icon" href="data:," />
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f0f4f8;
  padding: 20px;
  margin: 0;
}
.container {
  max-width: 700px;
  margin: 0 auto;
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
h1 {
  color: #2c3e50;
  margin-bottom: 10px;
  font-size: 28px;
}
.subtitle {
  color: #7f8c8d;
  margin-bottom: 30px;
  font-size: 15px;
}
.question { margin-bottom: 25px; }
label { display: block; font-weight: 600; margin-bottom: 8px; color: #34495e; font-size: 15px; }
.required { color: #e74c3c; font-weight: bold; }
input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e6ed;
  border-radius: 6px;
  font-size: 15px;
  transition: border-color 0.3s;
  box-sizing: border-box;
}
input:focus, select:focus { outline: none; border-color: #3498db; }
.checkbox-group, .radio-group { margin-top: 8px; }
.checkbox-group label, .radio-group label { display: flex; align-items: center; font-weight: normal; margin-bottom: 8px; cursor: pointer; }
input[type="checkbox"], input[type="radio"] { margin-right: 8px; cursor: pointer; width: 18px; height: 18px; }
.hidden { display: none; }
.error { color: #e74c3c; font-size: 13px; margin-top: 5px; display: none; }
.show-error { display: block; }
.message-box {
  background: #fff3cd;
  border: 2px solid #ffc107;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  color: #856404;
}
.message-box h3 { margin-top: 0; color: #856404; }
.info-box {
  background: #d1ecf1;
  border: 2px solid #17a2b8;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  color: #0c5460;
}
.info-box h3 { margin-top: 0; color: #0c5460; }
.success-box {
  background: #d4edda;
  border: 2px solid #28a745;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  color: #155724;
}
.success-box h3 { margin-top: 0; color: #155724; }
button {
  width: 100%;
  padding: 14px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
  margin-top: 20px;
}
button:hover { background: #2980b9; }
button:disabled { background: #95a5a6; cursor: not-allowed; }
.consent-label { display: flex; align-items: flex-start; gap: 8px; }
.consent-label input { margin-top: 3px; flex-shrink: 0; }
.success-message {
  background: #d4edda;
  border: 2px solid #28a745;
  color: #155724;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  display: none;
}
.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-top: none;
  z-index: 99;
  max-height: 150px;
  overflow-y: auto;
  background: white;
  width: 100%;
}
.autocomplete-item {
  padding: 10px;
  cursor: pointer;
}
.autocomplete-item:hover {
  background-color: #e9e9e9;
}
.code-verification {
  background: #e7f3ff;
  border: 2px solid #2196F3;
  border-radius: 8px;
  padding: 25px;
  margin: 20px 0;
  text-align: center;
}
.code-verification h3 {
  color: #1976D2;
  margin-top: 0;
}
.code-input {
  width: 200px !important;
  text-align: center;
  font-size: 24px;
  letter-spacing: 10px;
  font-weight: bold;
  margin: 15px auto;
}
input[readonly] {
  background-color: #f3f6f9;
  color: #555;
}
.date-picker-box {
  background: #f8f9fa;
  border: 2px solid #6c757d;
  border-radius: 8px;
  padding: 20px;
  margin: 15px 0;
}
.date-picker-box label {
  color: #495057;
  font-size: 14px;
}
input[type="date"] {
  font-size: 16px;
  padding: 10px;
}
</style>
</head>
<body>

<div class="container">
  <h1>Inscription Professionnels - Plateforme</h1>
  <p class="subtitle">Formulaire d'inscription pour les professionnels souhaitant √™tre r√©f√©renc√©s sur cette plateforme.</p>

  <div id="messageStop" class="message-box hidden">
    <h3>‚ö†Ô∏è Acc√®s non autoris√©</h3>
    <p>Ce formulaire est r√©serv√© aux professionnels disposant d'un num√©ro ADELI ou SIRET.</p>
  </div>

  <div id="messageEmailExiste" class="info-box hidden">
    <h3>üìß Email d√©j√† enregistr√©</h3>
    <p>Cet email est d√©j√† associ√© √† une inscription. Pour modifier vos informations, un code de v√©rification a √©t√© envoy√© √† votre adresse email.</p>
    <p><strong>Veuillez v√©rifier votre bo√Æte mail et entrer le code re√ßu ci-dessous.</strong></p>
  </div>

  <div id="messageEmailNouveau" class="success-box hidden">
    <h3>‚úÖ Nouvel email d√©tect√©</h3>
    <p>Pour des raisons de s√©curit√©, un code de v√©rification a √©t√© envoy√© √† votre adresse email.</p>
    <p><strong>Veuillez v√©rifier votre bo√Æte mail et entrer le code re√ßu ci-dessous.</strong></p>
  </div>

  <div id="codeVerificationBox" class="code-verification hidden">
    <h3>üîê V√©rification de s√©curit√©</h3>
    <p>Un code √† 6 chiffres a √©t√© envoy√© √† votre email</p>
    <input type="text" id="codeVerification" class="code-input" maxlength="6" placeholder="000000">
    <div class="error" id="errorCode">Code incorrect</div>
    <button type="button" id="btnVerifierCode">V√©rifier le code</button>
    <p style="font-size: 13px; color: #666; margin-top: 10px;">Le code est valable 10 minutes</p>
  </div>

  <div id="successMessage" class="success-message">
    <h3>‚úÖ Formulaire envoy√© avec succ√®s !</h3>
    <p>Merci pour votre inscription.</p>
  </div>

  <form id="formulaire">
    <!-- Email -->
    <div class="question">
      <label>Adresse e-mail <span class="required">*</span></label>
      <input type="email" name="email" id="email" required>
      <div class="error" id="errorEmail">Veuillez entrer une adresse e-mail valide</div>
    </div>
    <button type="button" id="btnVerifierEmail" style="margin-top:10px; background:#17a2b8;">V√©rifier mon e-mail</button>
    <p id="emailStatus" style="margin-top:8px; font-style:italic; color:#555;"></p>

    <!-- Bloc questions -->
    <div id="blocQuestions" class="hidden">

    <!-- Nom -->
    <div class="question">
      <label>Nom <span class="required">*</span></label>
      <input type="text" name="nom" id="nom" required>
    </div>

    <!-- Pr√©nom -->
    <div class="question">
      <label>Pr√©nom <span class="required">*</span></label>
      <input type="text" name="prenom" id="prenom" required>
    </div>

    <!-- T√©l√©phone -->
    <div class="question">
      <label>Votre n¬∞ de t√©l√©phone professionnel (optionnel)</label>
      <input type="tel" name="telephone" id="telephone" placeholder="Ex: 0601020304">
      <div class="error" id="errorTelephone">Veuillez entrer un num√©ro de t√©l√©phone valide (10 chiffres)</div>
    </div>

    <!-- Profession -->
    <div class="question">
      <label>S√©lectionner votre profession <span class="required">*</span></label>
      <select name="profession" id="profession" required>
        <option value="">-- Choisir une profession --</option>
        <option value="√âducateur sp√©cialis√©">√âducateur sp√©cialis√©</option>
        <option value="Ergoth√©rapeute">Ergoth√©rapeute</option>
        <option value="Psychologue">Psychologue</option>
        <option value="Psychomotricien">Psychomotricien</option>
        <option value="Orthophoniste">Orthophoniste</option>
      </select>
    </div>

    <!-- Num√©ro professionnel -->
    <div class="question">
      <label>Avez-vous un num√©ro professionnel ? <span class="required">*</span></label>
      <div class="radio-group">
        <label><input type="radio" name="typeNumero" value="adeli" id="radioAdeli"> Oui, j'ai un num√©ro ADELI</label>
        <label><input type="radio" name="typeNumero" value="siret" id="radioSiret"> Oui, j'ai un num√©ro SIRET</label>
        <label><input type="radio" name="typeNumero" value="non" id="radioNon" required> Non, je n'ai pas de num√©ro</label>
      </div>
    </div>

    <!-- ADELI -->
    <div class="question hidden" id="questionAdeli">
      <label>Veuillez indiquer votre num√©ro ADELI <span class="required">*</span></label>
      <input type="text" name="numeroAdeli" id="numeroAdeli" maxlength="9" placeholder="9 chiffres">
      <div class="error" id="errorAdeli">Le num√©ro ADELI doit contenir exactement 9 chiffres</div>
    </div>

    <!-- SIRET -->
    <div class="question hidden" id="questionSiret">
      <label>Veuillez indiquer votre num√©ro SIRET <span class="required">*</span></label>
      <input type="text" name="numeroSiret" id="numeroSiret" maxlength="14" placeholder="14 chiffres">
      <div class="error" id="errorSiret">Le num√©ro SIRET doit contenir exactement 14 chiffres</div>
    </div>

    <!-- Section suite -->
    <div id="suiteFomulaire" class="hidden">

    <!-- Public -->
    <div class="question">
      <label>Aupr√®s de quel(s) public(s) intervenez-vous ? <span class="required">*</span></label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="publics" value="Enfants (0-6 ans)"> Enfants (0-6 ans)</label>
        <label><input type="checkbox" name="publics" value="Enfants (7-12 ans)"> Enfants (7-12 ans)</label>
        <label><input type="checkbox" name="publics" value="Adolescents (12-18 ans)"> Adolescents (12-18 ans)</label>
        <label><input type="checkbox" name="publics" value="Adultes (au-del√† de 18 ans)"> Adultes (au-del√† de 18 ans)</label>
      </div>
      <div class="error" id="errorPublics">Veuillez s√©lectionner au moins un public</div>
    </div>

    <!-- Modes -->
    <div class="question">
      <label>Quels sont vos modes d'intervention ? <span class="required">*</span></label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="modesIntervention" value="√Ä domicile"> √Ä domicile</label>
        <label><input type="checkbox" name="modesIntervention" value="En cabinet"> En cabinet</label>
      </div>
      <div class="error" id="errorModes">Veuillez s√©lectionner au moins un mode d'intervention</div>
    </div>

    <!-- Visio -->
    <div class="question">
      <label>Proposez-vous des rendez-vous en visio ? <span class="required">*</span></label>
      <div class="radio-group">
        <label><input type="radio" name="visio" value="Oui" required> Oui</label>
        <label><input type="radio" name="visio" value="Non"> Non</label>
      </div>
    </div>

    <!-- D√©partement -->
    <div class="question">
      <label>Dans quel d√©partement intervenez-vous principalement ? <span class="required">*</span></label>
      <select name="departement" id="departement" required>
        <option value="">-- Choisir un d√©partement --</option>
        <option value="54 - Meurthe-et-Moselle">54 - Meurthe-et-Moselle</option>
        <option value="55 - Meuse">55 - Meuse</option>
        <option value="57 - Moselle">57 - Moselle</option>
        <option value="88 - Vosges">88 - Vosges</option>
      </select>
    </div>

    <!-- Commune -->
    <div class="question" style="position: relative;">
      <label>Quelle est votre commune principale d'intervention ? <span class="required">*</span></label>
      <input type="text" name="commune" id="communeInput" placeholder="Commencez √† taper votre commune..." autocomplete="off" required>
      <div id="autocompleteList" class="autocomplete-items"></div>
    </div>

    <!-- Rayon -->
    <div class="question">
      <label>Quel est votre rayon d'intervention ? <span class="required">*</span></label>
      <select name="rayon" id="rayon" required>
        <option value="">-- Choisir un rayon --</option>
        <option value="Aucun - en cabinet">Aucun - en cabinet</option>
        <option value="10 km">10 km</option>
        <option value="15 km">15 km</option>
        <option value="20 km">20 km</option>
        <option value="25 km">25 km</option>
        <option value="30 km">30 km</option>
        <option value="40 km">40 km</option>
        <option value="50 km">50 km</option>
        <option value="Tout mon d√©partement">Tout mon d√©partement</option>
      </select>
    </div>

    <!-- Disponibilit√© -->
    <div class="question">
      <label>Avez-vous une ou des disponibilit√©s √† venir pour de nouveaux b√©n√©ficiaires ? <span class="required">*</span></label>
      <div class="radio-group">
        <label><input type="radio" name="aDisponibilite" value="Oui" id="radioDispoOui" required> Oui</label>
        <label><input type="radio" name="aDisponibilite" value="Non" id="radioDispoNon"> Non</label>
      </div>
    </div>

    <!-- Date disponibilit√© -->
    <div class="question hidden" id="questionDateDispo">
      <div class="date-picker-box">
        <label>√Ä partir de quand avez-vous une disponibilit√© ? <span class="required">*</span></label>
        <input type="date" name="dateDisponibilite" id="dateDisponibilite">
        <div class="error" id="errorDate">Veuillez s√©lectionner une date</div>
      </div>
    </div>

    <!-- Consentement -->
    <div class="question">
      <label class="consent-label">
        <input type="checkbox" name="consentement" id="consentement" required>
        <span>J'accepte que mes donn√©es soient utilis√©es uniquement dans le cadre de cette mise en relation <span class="required">*</span></span>
      </label>
    </div>

    <!-- Bouton -->
    <button type="submit" id="btnSubmit">Envoyer le formulaire</button>
    
    </div> <!-- fin suiteFomulaire -->
    </div> <!-- fin blocQuestions -->
  </form>
</div>

<script>
// Configuration
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbaEis0cqzKjoHIRaXZ6fcB188xhx1yB3YTLafBNO_MBZG_hhAqSui_bBvdi-lGr-F/exec';
const API_GEO_GOUV = 'https://geo.api.gouv.fr/departements';

// Variables globales
let codeGenere = null;
let emailEnModification = null;
let estNouvelEmail = false;
let donneesUtilisateur = null;
let toutesLesCommunesDept = [];

// √âl√©ments DOM
const inputEmail = document.getElementById('email');
const btnVerifierEmail = document.getElementById('btnVerifierEmail');
const emailStatus = document.getElementById('emailStatus');
const blocQuestions = document.getElementById('blocQuestions');
const messageEmailExiste = document.getElementById('messageEmailExiste');
const messageEmailNouveau = document.getElementById('messageEmailNouveau');
const codeVerificationBox = document.getElementById('codeVerificationBox');
const inputCode = document.getElementById('codeVerification');
const btnVerifierCode = document.getElementById('btnVerifierCode');
const radioNon = document.getElementById('radioNon');
const radioAdeli = document.getElementById('radioAdeli');
const radioSiret = document.getElementById('radioSiret');
const questionAdeli = document.getElementById('questionAdeli');
const questionSiret = document.getElementById('questionSiret');
const inputAdeli = document.getElementById('numeroAdeli');
const inputSiret = document.getElementById('numeroSiret');
const suiteFomulaire = document.getElementById('suiteFomulaire');
const messageStop = document.getElementById('messageStop');
const inputTelephone = document.getElementById('telephone');
const selectDepartement = document.getElementById('departement');
const communeInput = document.getElementById('communeInput');
const autocompleteList = document.getElementById('autocompleteList');
const radioDispoOui = document.getElementById('radioDispoOui');
const radioDispoNon = document.getElementById('radioDispoNon');
const questionDateDispo = document.getElementById('questionDateDispo');
const dateDisponibilite = document.getElementById('dateDisponibilite');
const formulaire = document.getElementById('formulaire');
const btnSubmit = document.getElementById('btnSubmit');
const successMessage = document.getElementById('successMessage');

// Date minimum = aujourd'hui
const aujourdhui = new Date().toISOString().split('T')[0];
dateDisponibilite.setAttribute('min', aujourdhui);

// Gestion disponibilit√©
document.querySelectorAll('input[name="aDisponibilite"]').forEach(radio => {
  radio.addEventListener('change', function() {
    if (this.value === 'Oui') {
      questionDateDispo.classList.remove('hidden');
      dateDisponibilite.setAttribute('required', 'required');
    } else {
      questionDateDispo.classList.add('hidden');
      dateDisponibilite.removeAttribute('required');
      dateDisponibilite.value = '';
    }
  });
});

// Gestion type num√©ro
document.querySelectorAll('input[name="typeNumero"]').forEach(radio => {
  radio.addEventListener('change', function() {
    questionAdeli.classList.add('hidden');
    questionSiret.classList.add('hidden');
    suiteFomulaire.classList.add('hidden');
    messageStop.classList.add('hidden');
    inputAdeli.value = '';
    inputSiret.value = '';
    inputAdeli.removeAttribute('required');
    inputSiret.removeAttribute('required');

    if(this.value === 'non') {
      messageStop.classList.remove('hidden');
    } else if(this.value === 'adeli') { 
      questionAdeli.classList.remove('hidden'); 
      inputAdeli.setAttribute('required','required'); 
      suiteFomulaire.classList.remove('hidden'); 
    } else if(this.value === 'siret') { 
      questionSiret.classList.remove('hidden'); 
      inputSiret.setAttribute('required','required'); 
      suiteFomulaire.classList.remove('hidden'); 
    }
  });
});

// Validation num√©rique
inputAdeli.addEventListener('input', () => inputAdeli.value = inputAdeli.value.replace(/\D/g, ''));
inputSiret.addEventListener('input', () => inputSiret.value = inputSiret.value.replace(/\D/g, ''));
inputTelephone.addEventListener('input', () => inputTelephone.value = inputTelephone.value.replace(/\D/g, ''));
inputCode.addEventListener('input', () => inputCode.value = inputCode.value.replace(/\D/g, ''));

// PR√â-REMPLISSAGE
async function preremplirFormulaire(userData) {
  console.log('üîÑ Pr√©-remplissage avec:', userData);
  
  if (!userData) return;

  // Champs simples
  if (userData['Nom']) document.getElementById('nom').value = userData['Nom'];
  if (userData['Pr√©nom']) document.getElementById('prenom').value = userData['Pr√©nom'];
  if (userData['T√©l√©phone']) document.getElementById('telephone').value = userData['T√©l√©phone'];
  if (userData['Profession']) document.getElementById('profession').value = userData['Profession'];

  // Type num√©ro
  const typeNumero = userData['Type Num√©ro'] || '';
  if (typeNumero === 'adeli') {
    radioAdeli.checked = true;
    questionAdeli.classList.remove('hidden');
    inputAdeli.setAttribute('required', 'required');
    if (userData['Num√©ro ADELI']) inputAdeli.value = userData['Num√©ro ADELI'];
    suiteFomulaire.classList.remove('hidden');
  } else if (typeNumero === 'siret') {
    radioSiret.checked = true;
    questionSiret.classList.remove('hidden');
    inputSiret.setAttribute('required', 'required');
    if (userData['Num√©ro SIRET']) inputSiret.value = userData['Num√©ro SIRET'];
    suiteFomulaire.classList.remove('hidden');
  } else if (typeNumero === 'non') {
    radioNon.checked = true;
    messageStop.classList.remove('hidden');
  }

  // Publics
  if (userData['Publics']) {
    const publics = userData['Publics'].split(', ');
    document.querySelectorAll('input[name="publics"]').forEach(cb => {
      if (publics.includes(cb.value)) cb.checked = true;
    });
  }

  // Modes
  if (userData['Modes Intervention']) {
    const modes = userData['Modes Intervention'].split(', ');
    document.querySelectorAll('input[name="modesIntervention"]').forEach(cb => {
      if (modes.includes(cb.value)) cb.checked = true;
    });
  }

  // Visio
  if (userData['Visio']) {
    document.querySelectorAll('input[name="visio"]').forEach(radio => {
      if (radio.value === userData['Visio']) radio.checked = true;
    });
  }

  // D√©partement
  if (userData['D√©partement']) {
    selectDepartement.value = userData['D√©partement'];
    
    // Charger communes et pr√©-remplir
    if (userData['Commune']) {
      const numDept = userData['D√©partement'].split(' ')[0];
      communeInput.placeholder = '‚è≥ Chargement...';
      communeInput.disabled = true;

      try {
        const resp = await fetch(`${API_GEO_GOUV}/${numDept}/communes`);
        if (resp.ok) {
          const communes = await resp.json();
          communes.sort((a, b) => a.nom.localeCompare(b.nom));
          toutesLesCommunesDept = communes;
          communeInput.value = userData['Commune'];
          communeInput.disabled = false;
          communeInput.placeholder = 'Commencez √† taper...';
        }
      } catch (e) {
        console.error('Erreur communes:', e);
        communeInput.disabled = false;
      }
    }
  }

  // Rayon
  if (userData['Rayon']) document.getElementById('rayon').value = userData['Rayon'];

  // Disponibilit√©
  if (userData['A Disponibilit√©']) {
    if (userData['A Disponibilit√©'] === 'Oui') {
      radioDispoOui.checked = true;
      questionDateDispo.classList.remove('hidden');
      dateDisponibilite.setAttribute('required', 'required');
      
      if (userData['Date Disponibilit√©']) {
        const dateStr = userData['Date Disponibilit√©'];
        if (dateStr.includes('/')) {
          const [j, m, a] = dateStr.split('/');
          dateDisponibilite.value = `${a}-${m}-${j}`;
        } else {
          dateDisponibilite.value = dateStr;
        }
      }
    } else {
      radioDispoNon.checked = true;
    }
  }

  // Consentement
  document.getElementById('consentement').checked = true;
  
  console.log('‚úÖ Pr√©-remplissage termin√©');
}

// V√âRIFICATION EMAIL
inputEmail.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    btnVerifierEmail.click();
  }
});

btnVerifierEmail.addEventListener('click', async function() {
  const email = inputEmail.value.trim();

  if (!email || !email.includes('@')) {
    alert("‚ö†Ô∏è Veuillez entrer une adresse e-mail valide.");
    return;
  }

  btnVerifierEmail.disabled = true;
  btnVerifierEmail.textContent = "‚è≥ V√©rification...";
  emailStatus.textContent = "V√©rification en cours...";
  
  blocQuestions.classList.add('hidden');
  messageEmailExiste.classList.add('hidden');
  messageEmailNouveau.classList.add('hidden');
  codeVerificationBox.classList.add('hidden');

  try {
    const url = `${GOOGLE_SCRIPT_URL}?action=verifierEmail&email=${encodeURIComponent(email)}`;
    console.log('üåê Appel:', url);
    
    const response = await fetch(url);
    const result = await response.json();
    
    console.log('üì¶ R√©ponse:', result);

    codeGenere = result.code;
    donneesUtilisateur = result.userData || null;

    if (result.existe) {
      emailEnModification = email;
      estNouvelEmail = false;
      messageEmailExiste.classList.remove('hidden');
      codeVerificationBox.classList.remove('hidden');
      emailStatus.textContent = "‚ö†Ô∏è Email existant. Code envoy√©.";
      console.log('‚úÖ Donn√©es r√©cup√©r√©es:', donneesUtilisateur);
    } else {
      estNouvelEmail = true;
      donneesUtilisateur = null;
      messageEmailNouveau.classList.remove('hidden');
      codeVerificationBox.classList.remove('hidden');
      emailStatus.textContent = "‚úÖ Nouvel email. Code envoy√©.";
    }
  } catch (error) {
    console.error('‚ùå Erreur:', error);
    emailStatus.textContent = "‚ùå Erreur de v√©rification.";
  }

  btnVerifierEmail.disabled = false;
  btnVerifierEmail.textContent = "V√©rifier mon e-mail";
});

// CHARGEMENT COMMUNES
selectDepartement.addEventListener('change', async function() {
  const dept = this.value;
  autocompleteList.innerHTML = '';
  toutesLesCommunesDept = [];

  if(!dept) return;
  
  const numDept = dept.split(' ')[0];
  communeInput.placeholder = '‚è≥ Chargement...';
  communeInput.disabled = true;

  try {
    const resp = await fetch(`${API_GEO_GOUV}/${numDept}/communes`);
    if (!resp.ok) throw new Error('Erreur API');
    
    const communes = await resp.json();
    communes.sort((a, b) => a.nom.localeCompare(b.nom));
    toutesLesCommunesDept = communes;
    
    communeInput.placeholder = 'Commencez √† taper...';
    communeInput.disabled = false;
    console.log(`‚úÖ ${communes.length} communes charg√©es`);
  } catch(e) {
    console.error('Erreur communes:', e);
    communeInput.placeholder = 'Erreur, r√©essayez...';
    communeInput.disabled = false;
    alert('Erreur lors du chargement des communes.');
  }
});

// AUTOCOMPLETE COMMUNES
communeInput.addEventListener('input', function() {
  const val = this.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
  autocompleteList.innerHTML = '';
  
  if (!val) return;

  const filtered = toutesLesCommunesDept.filter(c => {
    const nomSansAccent = c.nom.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return nomSansAccent.includes(val);
  });

  filtered.slice(0, 10).forEach(c => {
    const div = document.createElement('div');
    div.textContent = c.nom;
    div.classList.add('autocomplete-item');
    div.addEventListener('click', () => { 
      communeInput.value = c.nom; 
      autocompleteList.innerHTML = ''; 
    });
    autocompleteList.appendChild(div);
  });
});

document.addEventListener('click', e => { 
  if(e.target !== communeInput) autocompleteList.innerHTML = ''; 
});

// V√âRIFICATION CODE
btnVerifierCode.addEventListener('click', async function() {
  const codeEntre = inputCode.value.trim();
  const errorCode = document.getElementById('errorCode');
  errorCode.classList.remove('show-error');
  
  if (codeEntre.length !== 6) {
    errorCode.textContent = 'Le code doit contenir 6 chiffres';
    errorCode.classList.add('show-error');
    return;
  }

  if (codeEntre === codeGenere) {
    console.log('‚úÖ Code correct');
    
    codeVerificationBox.classList.add('hidden');
    messageEmailExiste.classList.add('hidden');
    messageEmailNouveau.classList.add('hidden');
    emailStatus.textContent = "‚úÖ Code v√©rifi√©.";

    // Afficher formulaire
    blocQuestions.classList.remove('hidden');

    if (estNouvelEmail) {
      // NOUVEAU : sections progressives
      alert('‚úÖ Email v√©rifi√© ! Remplissez le formulaire.');
    } else {
      // EXISTANT : tout afficher + pr√©-remplir
      alert('‚úÖ Code v√©rifi√© ! Pr√©-remplissage en cours...');
      
      if (donneesUtilisateur) {
        await preremplirFormulaire(donneesUtilisateur);
      }
    }

    // Verrouiller email
    inputEmail.readOnly = true;
    btnVerifierEmail.style.display = 'none';

  } else {
    errorCode.textContent = 'Code incorrect';
    errorCode.classList.add('show-error');
  }
});

// ENVOI FORMULAIRE
formulaire.addEventListener('submit', async function(e){
  e.preventDefault();
  document.querySelectorAll('.error').forEach(el => el.classList.remove('show-error'));

  let isValid = true;

  // Validations
  if(!document.getElementById('email').validity.valid){
    document.getElementById('errorEmail').classList.add('show-error');
    isValid = false;
  }

  const telephone = inputTelephone.value.trim();
  if(telephone && telephone.length !== 10){
    document.getElementById('errorTelephone').classList.add('show-error');
    isValid = false;
  }

  if(radioAdeli.checked && inputAdeli.value.length !== 9){
    document.getElementById('errorAdeli').classList.add('show-error');
    isValid = false;
  }

  if(radioSiret.checked && inputSiret.value.length !== 14){
    document.getElementById('errorSiret').classList.add('show-error');
    isValid = false;
  }

  if(!radioNon.checked) {
    const publicsChecked = document.querySelectorAll('input[name="publics"]:checked');
    if(publicsChecked.length === 0){
      document.getElementById('errorPublics').classList.add('show-error');
      isValid = false;
    }

    const modesChecked = document.querySelectorAll('input[name="modesIntervention"]:checked');
    if(modesChecked.length === 0){
      document.getElementById('errorModes').classList.add('show-error');
      isValid = false;
    }

    if(radioDispoOui.checked && !dateDisponibilite.value) {
      document.getElementById('errorDate').classList.add('show-error');
      isValid = false;
    }

    if(!selectDepartement.value) isValid = false;
    if(!communeInput.value.trim()) isValid = false;
    if(!document.getElementById('rayon').value) isValid = false;
    if(!document.getElementById('consentement').checked) isValid = false;
  }

  if(!isValid){
    alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires.');
    return;
  }

  // Pr√©paration donn√©es
  const formData = new FormData(this);
  const now = new Date();
  const frenchTime = new Intl.DateTimeFormat('fr-FR', {
    timeZone: 'Europe/Paris',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  }).format(now);
  
  const data = { horodateur: frenchTime };
  
  for(let [key, value] of formData.entries()){
    if(data[key]){ 
      if(Array.isArray(data[key])) data[key].push(value); 
      else data[key] = [data[key], value]; 
    } else data[key] = value;
  }

  // Formatage
  if(Array.isArray(data.publics)) data.publics = data.publics.join(', ');
  if(Array.isArray(data.modesIntervention)) data.modesIntervention = data.modesIntervention.join(', ');
  data.consentement = data.consentement === 'on' ? "J'accepte" : '';

  if (estNouvelEmail) {
    data.statutEmail = 'Nouvel email v√©rifi√©';
  } else if (emailEnModification) {
    data.statutEmail = 'Modification - Email existant v√©rifi√©';
  }

  data.codeVerifie = "oui";

  await envoyerFormulaire(data);
});

// FONCTION ENVOI
async function envoyerFormulaire(data) {
  btnSubmit.disabled = true; 
  btnSubmit.textContent = '‚è≥ Envoi en cours...';

  try {
    const res = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(data),
      headers: {'Content-Type': 'text/plain'},
      redirect: 'follow'
    });
    
    const textResponse = await res.text();
    console.log('üì© R√©ponse:', textResponse);
    
    const response = JSON.parse(textResponse);
    
    if(response.result === 'error') {
      alert(response.message || 'Erreur lors de l\'envoi');
      btnSubmit.disabled = false;
      btnSubmit.textContent = 'Envoyer le formulaire';
      return;
    }
    
    console.log('‚úÖ Envoi r√©ussi');

    // R√©initialisation
    formulaire.reset(); 
    successMessage.style.display = 'block'; 
    formulaire.style.display = 'none';
    autocompleteList.innerHTML = ''; 
    suiteFomulaire.classList.add('hidden');
    messageEmailExiste.classList.add('hidden');
    messageEmailNouveau.classList.add('hidden');
    codeVerificationBox.classList.add('hidden');
    blocQuestions.classList.add('hidden');
    emailEnModification = null;
    estNouvelEmail = false;
    codeGenere = null;
    donneesUtilisateur = null;
    successMessage.scrollIntoView({ behavior: 'smooth' });

  } catch(err){
    console.error('‚ùå Erreur:', err);
    alert('Erreur lors de l\'envoi: ' + err.message);
  } finally {
    btnSubmit.disabled = false; 
    btnSubmit.textContent = 'Envoyer le formulaire';
  }
}
</script>
</body>
</html>
