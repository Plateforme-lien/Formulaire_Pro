<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inscription Professionnels</title>
<link rel="icon" href="data:," />
<style>
body{font-family:'Segoe UI',sans-serif;background:#f0f4f8;padding:20px;margin:0}
.container{max-width:700px;margin:0 auto;background:white;padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
h1{color:#2c3e50;margin-bottom:10px;font-size:28px}
.subtitle{color:#7f8c8d;margin-bottom:30px;font-size:15px}
.question{margin-bottom:25px}
label{display:block;font-weight:600;margin-bottom:8px;color:#34495e;font-size:15px}
.required{color:#e74c3c;font-weight:bold}
input[type="text"],input[type="email"],input[type="tel"],input[type="date"],select{width:100%;padding:12px;border:2px solid #e0e6ed;border-radius:6px;font-size:15px;box-sizing:border-box}
input:focus,select:focus{outline:none;border-color:#3498db}
.checkbox-group label,.radio-group label{display:flex;align-items:center;font-weight:normal;margin-bottom:8px;cursor:pointer}
input[type="checkbox"],input[type="radio"]{margin-right:8px;cursor:pointer;width:18px;height:18px}
.hidden{display:none}
.error{color:#e74c3c;font-size:13px;margin-top:5px;display:none}
.show-error{display:block}
.message-box{background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:20px;margin:20px 0;color:#856404}
.info-box{background:#d1ecf1;border:2px solid #17a2b8;border-radius:8px;padding:20px;margin:20px 0;color:#0c5460}
.success-box{background:#d4edda;border:2px solid #28a745;border-radius:8px;padding:20px;margin:20px 0;color:#155724}
.message-box h3,.info-box h3,.success-box h3{margin-top:0}
button{width:100%;padding:14px;background:#3498db;color:white;border:none;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer;margin-top:20px}
button:hover{background:#2980b9}
button:disabled{background:#95a5a6;cursor:not-allowed}
.success-message{background:#d4edda;border:2px solid #28a745;color:#155724;padding:20px;border-radius:8px;text-align:center;display:none}
.code-verification{background:#e7f3ff;border:2px solid #2196F3;border-radius:8px;padding:25px;margin:20px 0;text-align:center}
.code-input{width:200px!important;text-align:center;font-size:24px;letter-spacing:10px;font-weight:bold;margin:15px auto}
.autocomplete-items{position:absolute;border:1px solid #d4d4d4;border-top:none;z-index:99;max-height:150px;overflow-y:auto;background:white;width:100%}
.autocomplete-item{padding:10px;cursor:pointer}
.autocomplete-item:hover{background-color:#e9e9e9}
</style>
</head>
<body>
<div class="container">
  <h1>Inscription Professionnels</h1>
  <p class="subtitle">Formulaire d'inscription pour les professionnels.</p>

  <div id="messageStop" class="message-box hidden">
    <h3>‚ö†Ô∏è Acc√®s non autoris√©</h3>
    <p>Formulaire r√©serv√© aux professionnels avec num√©ro ADELI ou SIRET.</p>
  </div>

  <div id="messageEmailExiste" class="info-box hidden">
    <h3>üìß Email d√©j√† enregistr√©</h3>
    <p>Un code de v√©rification a √©t√© envoy√© √† votre adresse email.</p>
  </div>

  <div id="messageEmailNouveau" class="success-box hidden">
    <h3>‚úÖ Nouvel email</h3>
    <p>Un code de v√©rification a √©t√© envoy√©.</p>
  </div>

  <div id="codeVerificationBox" class="code-verification hidden">
    <h3>üîê V√©rification</h3>
    <p>Entrez le code √† 6 chiffres</p>
    <input type="text" id="codeVerification" class="code-input" maxlength="6" placeholder="000000">
    <div class="error" id="errorCode">Code incorrect</div>
    <button type="button" id="btnVerifierCode">V√©rifier le code</button>
  </div>

  <div id="successMessage" class="success-message">
    <h3>‚úÖ Envoy√© !</h3>
    <p>Merci pour votre inscription.</p>
  </div>

  <form id="formulaire">
    <div class="question">
      <label>Email <span class="required">*</span></label>
      <input type="email" id="email" required>
    </div>
    <button type="button" id="btnVerifierEmail" style="background:#17a2b8">V√©rifier mon e-mail</button>
    <p id="emailStatus" style="margin-top:8px;font-style:italic;color:#555"></p>

    <div id="blocQuestions" class="hidden">
      <div class="question">
        <label>Nom <span class="required">*</span></label>
        <input type="text" id="nom" required>
      </div>
      <div class="question">
        <label>Pr√©nom <span class="required">*</span></label>
        <input type="text" id="prenom" required>
      </div>
      <div class="question">
        <label>T√©l√©phone (optionnel)</label>
        <input type="tel" id="telephone" placeholder="0601020304">
      </div>
      <div class="question">
        <label>Profession <span class="required">*</span></label>
        <select id="profession" required>
          <option value="">-- Choisir --</option>
          <option value="√âducateur sp√©cialis√©">√âducateur sp√©cialis√©</option>
          <option value="Ergoth√©rapeute">Ergoth√©rapeute</option>
          <option value="Psychologue">Psychologue</option>
          <option value="Psychomotricien">Psychomotricien</option>
          <option value="Orthophoniste">Orthophoniste</option>
        </select>
      </div>
      <div class="question">
        <label>Avez-vous un num√©ro professionnel ? <span class="required">*</span></label>
        <div class="radio-group">
          <label><input type="radio" name="typeNumero" value="adeli" id="radioAdeli"> ADELI</label>
          <label><input type="radio" name="typeNumero" value="siret" id="radioSiret"> SIRET</label>
          <label><input type="radio" name="typeNumero" value="non" id="radioNon"> Non</label>
        </div>
      </div>
      <div class="question hidden" id="questionAdeli">
        <label>Num√©ro ADELI <span class="required">*</span></label>
        <input type="text" id="numeroAdeli" maxlength="9" placeholder="9 chiffres">
      </div>
      <div class="question hidden" id="questionSiret">
        <label>Num√©ro SIRET <span class="required">*</span></label>
        <input type="text" id="numeroSiret" maxlength="14" placeholder="14 chiffres">
      </div>
      
      <div id="suiteFomulaire" class="hidden">
        <div class="question">
          <label>Publics <span class="required">*</span></label>
          <div class="checkbox-group">
            <label><input type="checkbox" value="Enfants (0-6 ans)"> Enfants (0-6 ans)</label>
            <label><input type="checkbox" value="Enfants (7-12 ans)"> Enfants (7-12 ans)</label>
            <label><input type="checkbox" value="Adolescents (12-18 ans)"> Adolescents (12-18 ans)</label>
            <label><input type="checkbox" value="Adultes (au-del√† de 18 ans)"> Adultes (au-del√† de 18 ans)</label>
          </div>
        </div>
        <div class="question">
          <label>Modes d'intervention <span class="required">*</span></label>
          <div class="checkbox-group">
            <label><input type="checkbox" value="√Ä domicile"> √Ä domicile</label>
            <label><input type="checkbox" value="En cabinet"> En cabinet</label>
          </div>
        </div>
        <div class="question">
          <label>Visio ? <span class="required">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="visio" value="Oui"> Oui</label>
            <label><input type="radio" name="visio" value="Non"> Non</label>
          </div>
        </div>
        <div class="question">
          <label>D√©partement <span class="required">*</span></label>
          <select id="departement" required>
            <option value="">-- Choisir --</option>
            <option value="54 - Meurthe-et-Moselle">54 - Meurthe-et-Moselle</option>
            <option value="55 - Meuse">55 - Meuse</option>
            <option value="57 - Moselle">57 - Moselle</option>
            <option value="88 - Vosges">88 - Vosges</option>
          </select>
        </div>
        <div class="question" style="position:relative">
          <label>Commune <span class="required">*</span></label>
          <input type="text" id="communeInput" placeholder="Tapez votre commune..." autocomplete="off" required>
          <div id="autocompleteList" class="autocomplete-items"></div>
        </div>
        <div class="question">
          <label>Rayon d'intervention <span class="required">*</span></label>
          <select id="rayon" required>
            <option value="">-- Choisir --</option>
            <option value="Aucun - en cabinet">Aucun - en cabinet</option>
            <option value="10 km">10 km</option>
            <option value="15 km">15 km</option>
            <option value="20 km">20 km</option>
            <option value="30 km">30 km</option>
          </select>
        </div>
        <div class="question">
          <label>Disponibilit√©s ? <span class="required">*</span></label>
          <div class="radio-group">
            <label><input type="radio" name="dispo" value="Oui" id="radioDispoOui"> Oui</label>
            <label><input type="radio" name="dispo" value="Non" id="radioDispoNon"> Non</label>
          </div>
        </div>
        <div class="question hidden" id="questionDateDispo">
          <label>√Ä partir de quand ? <span class="required">*</span></label>
          <input type="date" id="dateDisponibilite">
        </div>
        <div class="question">
          <label style="display:flex;align-items:start;gap:8px">
            <input type="checkbox" id="consentement" required style="margin-top:3px">
            <span>J'accepte que mes donn√©es soient utilis√©es <span class="required">*</span></span>
          </label>
        </div>
        <button type="submit" id="btnSubmit">Envoyer</button>
      </div>
    </div>
  </form>
</div>

<script>
const GOOGLE_SCRIPT_URL='https://script.google.com/macros/s/AKfycbzbaEis0cqzKjoHIRaXZ6fcB188xhx1yB3YTLafBNO_MBZG_hhAqSui_bBvdi-lGr-F/exec';
const API_GEO='https://geo.api.gouv.fr/departements';
let codeGenere=null,emailEnModification=null,estNouvelEmail=false,donneesUtilisateur=null,communes=[];
const elems={
  email:document.getElementById('email'),
  btnVerifEmail:document.getElementById('btnVerifierEmail'),
  emailStatus:document.getElementById('emailStatus'),
  blocQ:document.getElementById('blocQuestions'),
  msgExiste:document.getElementById('messageEmailExiste'),
  msgNouveau:document.getElementById('messageEmailNouveau'),
  codeBox:document.getElementById('codeVerificationBox'),
  inputCode:document.getElementById('codeVerification'),
  btnVerifCode:document.getElementById('btnVerifierCode'),
  radioNon:document.getElementById('radioNon'),
  radioAdeli:document.getElementById('radioAdeli'),
  radioSiret:document.getElementById('radioSiret'),
  qAdeli:document.getElementById('questionAdeli'),
  qSiret:document.getElementById('questionSiret'),
  inputAdeli:document.getElementById('numeroAdeli'),
  inputSiret:document.getElementById('numeroSiret'),
  suite:document.getElementById('suiteFomulaire'),
  msgStop:document.getElementById('messageStop'),
  tel:document.getElementById('telephone'),
  dept:document.getElementById('departement'),
  commune:document.getElementById('communeInput'),
  autoList:document.getElementById('autocompleteList'),
  dispoOui:document.getElementById('radioDispoOui'),
  dispoNon:document.getElementById('radioDispoNon'),
  qDate:document.getElementById('questionDateDispo'),
  dateD:document.getElementById('dateDisponibilite'),
  form:document.getElementById('formulaire'),
  btnSubmit:document.getElementById('btnSubmit'),
  success:document.getElementById('successMessage')
};
elems.dateD.setAttribute('min',new Date().toISOString().split('T')[0]);
document.querySelectorAll('input[name="dispo"]').forEach(r=>r.addEventListener('change',function(){
  if(this.value==='Oui'){elems.qDate.classList.remove('hidden');elems.dateD.required=true}
  else{elems.qDate.classList.add('hidden');elems.dateD.required=false;elems.dateD.value=''}
}));
document.querySelectorAll('input[name="typeNumero"]').forEach(r=>r.addEventListener('change',function(){
  elems.qAdeli.classList.add('hidden');elems.qSiret.classList.add('hidden');elems.suite.classList.add('hidden');elems.msgStop.classList.add('hidden');
  elems.inputAdeli.value='';elems.inputSiret.value='';elems.inputAdeli.required=false;elems.inputSiret.required=false;
  if(this.value==='non')elems.msgStop.classList.remove('hidden');
  else if(this.value==='adeli'){elems.qAdeli.classList.remove('hidden');elems.inputAdeli.required=true;elems.suite.classList.remove('hidden')}
  else if(this.value==='siret'){elems.qSiret.classList.remove('hidden');elems.inputSiret.required=true;elems.suite.classList.remove('hidden')}
}));
elems.inputAdeli.addEventListener('input',()=>elems.inputAdeli.value=elems.inputAdeli.value.replace(/\D/g,''));
elems.inputSiret.addEventListener('input',()=>elems.inputSiret.value=elems.inputSiret.value.replace(/\D/g,''));
elems.tel.addEventListener('input',()=>elems.tel.value=elems.tel.value.replace(/\D/g,''));
elems.inputCode.addEventListener('input',()=>elems.inputCode.value=elems.inputCode.value.replace(/\D/g,''));

elems.btnVerifEmail.addEventListener('click',async function(){
  const email=elems.email.value.trim();
  if(!email||!email.includes('@')){alert('Email invalide');return}
  elems.btnVerifEmail.disabled=true;elems.btnVerifEmail.textContent='‚è≥ V√©rification...';
  elems.blocQ.classList.add('hidden');elems.msgExiste.classList.add('hidden');elems.msgNouveau.classList.add('hidden');elems.codeBox.classList.add('hidden');
  try{
    const url=`${GOOGLE_SCRIPT_URL}?action=verifierEmail&email=${encodeURIComponent(email)}`;
    const resp=await fetch(url);
    const result=await resp.json();
    console.log('üì¶ R√©ponse:',result);
    codeGenere=result.code;donneesUtilisateur=result.userData||null;
    if(result.existe){emailEnModification=email;estNouvelEmail=false;elems.msgExiste.classList.remove('hidden');elems.codeBox.classList.remove('hidden');elems.emailStatus.textContent='‚ö†Ô∏è Email existant'}
    else{estNouvelEmail=true;elems.msgNouveau.classList.remove('hidden');elems.codeBox.classList.remove('hidden');elems.emailStatus.textContent='‚úÖ Nouvel email'}
  }catch(e){console.error(e);elems.emailStatus.textContent='‚ùå Erreur'}
  elems.btnVerifEmail.disabled=false;elems.btnVerifEmail.textContent='V√©rifier';
});

elems.btnVerifCode.addEventListener('click',function(){
  const code=elems.inputCode.value.trim();
  if(code.length!==6||code!==codeGenere){document.getElementById('errorCode').classList.add('show-error');return}
  elems.codeBox.classList.add('hidden');elems.msgExiste.classList.add('hidden');elems.msgNouveau.classList.add('hidden');
  elems.blocQ.classList.remove('hidden');
  if(estNouvelEmail)alert('‚úÖ Email v√©rifi√©');
  else{alert('‚úÖ Pr√©-remplissage...');if(donneesUtilisateur)preremplir(donneesUtilisateur)}
  elems.email.readOnly=true;elems.btnVerifEmail.style.display='none';
});

function preremplir(d){
  console.log('üîÑ Pr√©-remplissage',d);
  if(d.Nom)document.getElementById('nom').value=d.Nom;
  if(d.Pr√©nom)document.getElementById('prenom').value=d.Pr√©nom;
  if(d.T√©l√©phone)elems.tel.value=d.T√©l√©phone;
  if(d.Profession)document.getElementById('profession').value=d.Profession;
  const tNum=d['Type Num√©ro']||'';
  if(tNum==='adeli'){elems.radioAdeli.checked=true;elems.qAdeli.classList.remove('hidden');elems.suite.classList.remove('hidden');if(d['Num√©ro ADELI'])elems.inputAdeli.value=d['Num√©ro ADELI']}
  else if(tNum==='siret'){elems.radioSiret.checked=true;elems.qSiret.classList.remove('hidden');elems.suite.classList.remove('hidden');if(d['Num√©ro SIRET'])elems.inputSiret.value=d['Num√©ro SIRET']}
  else if(tNum==='non'){elems.radioNon.checked=true;elems.msgStop.classList.remove('hidden')}
  if(d.Publics){const ps=d.Publics.split(', ');document.querySelectorAll('input[type="checkbox"][value]').forEach(cb=>{if(ps.includes(cb.value))cb.checked=true})}
  if(d.Visio)document.querySelectorAll('input[name="visio"]').forEach(r=>{if(r.value===d.Visio)r.checked=true});
  if(d.D√©partement)elems.dept.value=d.D√©partement;
  if(d.Commune)elems.commune.value=d.Commune;
  if(d.Rayon)elems.rayon.value=d.Rayon;
  if(d['A Disponibilit√©']==='Oui'){elems.dispoOui.checked=true;elems.qDate.classList.remove('hidden');if(d['Date Disponibilit√©'])elems.dateD.value=d['Date Disponibilit√©']}
  else elems.dispoNon.checked=true;
  document.getElementById('consentement').checked=true;
}

elems.form.addEventListener('submit',async function(e){
  e.preventDefault();
  const now=new Date();
  const frTime=new Intl.DateTimeFormat('fr-FR',{timeZone:'Europe/Paris',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(now);
  const data={
    Horodateur:frTime,Email:elems.email.value,Nom:document.getElementById('nom').value,Pr√©nom:document.getElementById('prenom').value,T√©l√©phone:elems.tel.value,Profession:document.getElementById('profession').value,
    'Type Num√©ro':'','Num√©ro ADELI':'','Num√©ro SIRET':'',Publics:'','Modes Intervention':'',Visio:'',D√©partement:elems.dept.value,Commune:elems.commune.value,Rayon:elems.rayon.value,
    'A Disponibilit√©':'','Date Disponibilit√©':'',Consentement:document.getElementById('consentement').checked?"J'accepte":'','Statut Email':'',codeVerifie:'oui'
  };
  if(elems.radioAdeli.checked){data['Type Num√©ro']='adeli';data['Num√©ro ADELI']=elems.inputAdeli.value}
  else if(elems.radioSiret.checked){data['Type Num√©ro']='siret';data['Num√©ro SIRET']=elems.inputSiret.value}
  else if(elems.radioNon.checked)data['Type Num√©ro']='non';
  const pubs=[];document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb=>pubs.push(cb.value));data.Publics=pubs.join(', ');
  const visio=document.querySelector('input[name="visio"]:checked');if(visio)data.Visio=visio.value;
  if(elems.dispoOui.checked){data['A Disponibilit√©']='Oui';data['Date Disponibilit√©']=elems.dateD.value}
  else if(elems.dispoNon.checked)data['A Disponibilit√©']='Non';
  if(estNouvelEmail)data['Statut Email']='Nouvel email';
  else if(emailEnModification)data['Statut Email']='Modification';
  console.log('üì§ Envoi:',data);
  try{
    const res=await fetch(GOOGLE_SCRIPT_URL,{method:'POST',body:JSON.stringify(data),headers:{'Content-Type':'text/plain'}});
    const txt=await res.text();console.log('üì©',txt);
    const r=JSON.parse(txt);
    if(r.result==='error'){alert(r.message);return}
    elems.form.reset();elems.success.style.display='block';elems.form.style.display='none';
  }catch(err){console.error(err);alert('Erreur')}
});
</script>
</body>
</html>
